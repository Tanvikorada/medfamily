<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediGarden | Family Health Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Firebase (compat) SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2D9F75">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%232D9F75' width='180' height='180'/><text x='50%' y='50%' font-size='80' fill='white' text-anchor='middle' dy='.3em'>üå±</text></svg>">

    <style>
        :root {
            --bg: #eef3f7;
            --bg-deep: #0f172a;
            --surface: #ffffff;
            --surface-soft: #f8fafc;
            --line: #dbe3ea;
            --text: #0f172a;
            --muted: #475569;
            --brand: #0f766e;
            --brand-strong: #115e59;
            --danger: #b91c1c;
            --radius-lg: 18px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Manrope', sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 600px at -10% -20%, #dff8f2 0%, transparent 60%),
                radial-gradient(900px 500px at 110% -20%, #e7ecff 0%, transparent 55%),
                linear-gradient(180deg, #f6f9fc 0%, #eef3f7 100%);
        }

        .notification-sound {
            display: none;
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .auth-shell {
            background:
                radial-gradient(700px 300px at 10% 15%, rgba(45, 212, 191, 0.22), transparent 65%),
                radial-gradient(600px 260px at 90% 10%, rgba(59, 130, 246, 0.18), transparent 60%),
                linear-gradient(165deg, #0f172a 0%, #1e293b 48%, #0f766e 100%);
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(255, 255, 255, 0.55);
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
        }

        .app-shell {
            min-height: 100vh;
            background: transparent;
        }

        .app-nav {
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 50%, #0f766e 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(8px);
        }

        .brand-mark {
            width: 2.35rem;
            height: 2.35rem;
            border-radius: 0.8rem;
            display: grid;
            place-items: center;
            font-size: 0.82rem;
            font-weight: 800;
            color: #ffffff;
            background: linear-gradient(135deg, #0f766e 0%, #0ea5a4 100%);
            border: 1px solid rgba(255, 255, 255, 0.35);
            letter-spacing: 0.04em;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            letter-spacing: -0.02em;
            font-weight: 800;
        }

        p {
            line-height: 1.55;
        }

        main {
            animation: fadeIn 220ms ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .premium-card,
        .app-shell .bg-white,
        .app-shell .rounded-2xl {
            border: 1px solid var(--line);
            border-radius: var(--radius-lg);
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .premium-card:hover,
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
        }

        .gradient-text {
            background: linear-gradient(135deg, #0f766e 0%, #0f172a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .premium-btn,
        button {
            border-radius: 12px;
            font-weight: 700;
            letter-spacing: 0.01em;
            transition: all 0.2s ease;
        }

        .premium-btn:active,
        button:active {
            transform: scale(0.985);
        }

        input,
        select,
        textarea {
            border-radius: 12px !important;
            border-color: var(--line) !important;
            background: #ffffff;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none !important;
            border-color: #0f766e !important;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.14) !important;
        }

        .bg-\[\#2D9F75\],
        .from-\[\#2D9F75\] {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-strong) 100%) !important;
            color: #fff !important;
        }

        .hover\:bg-\[\#258562\]:hover,
        .hover\:bg-blue-600:hover,
        .hover\:bg-green-600:hover,
        .hover\:bg-red-600:hover {
            filter: brightness(0.95);
        }

        .bg-red-500 {
            background-color: var(--danger) !important;
        }

        .text-purple-600,
        .text-purple-700 {
            color: #0f766e !important;
        }

        .border-purple-200 {
            border-color: #99f6e4 !important;
        }

        .bg-purple-50 {
            background-color: #f0fdfa !important;
        }

        .alert-badge {
            animation: pulse 1.8s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }
        }

        .reminder-panel {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 120;
            width: 320px;
            max-width: calc(100% - 36px);
        }

        .garden-soil {
            background: linear-gradient(180deg, #7f6a50 0%, #5d4534 100%);
        }

        .garden-plant {
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {

            0%,
            100% {
                transform: rotate(-1deg);
            }

            50% {
                transform: rotate(1deg);
            }
        }

        .achievement-card {
            min-width: 180px;
        }

        .garden-container {
            perspective: 1200px;
            background: linear-gradient(180deg, #b2dfff 0%, #e9f8ff 40%, #d8f4df 100%);
            position: relative;
            overflow: hidden;
            border-radius: 24px;
        }

        .garden-scene {
            transform-style: preserve-3d;
            position: relative;
            width: 100%;
            height: 100%;
        }

        @keyframes particles {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) translateX(20px);
                opacity: 0;
            }
        }

        @keyframes glow {

            0%,
            100% {
                filter: drop-shadow(0 0 5px rgba(15, 118, 110, 0.25));
            }

            50% {
                filter: drop-shadow(0 0 16px rgba(15, 118, 110, 0.6));
            }
        }

        @keyframes float-advanced {

            0%,
            100% {
                transform: translateY(0px) translateX(0);
            }

            25% {
                transform: translateY(-15px) translateX(10px);
            }

            50% {
                transform: translateY(-30px) translateX(0);
            }

            75% {
                transform: translateY(-15px) translateX(-10px);
            }
        }

        .plant-main {
            transform-style: preserve-3d;
            filter: drop-shadow(0 15px 35px rgba(0, 0, 0, 0.3));
        }

        .flower-deco {
            animation: float-advanced 5s ease-in-out infinite;
            transform-style: preserve-3d;
        }

        .soil-shadow {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to top, rgba(127, 106, 80, 0.95), rgba(127, 106, 80, 0.6), transparent);
            box-shadow: inset 0 20px 40px rgba(0, 0, 0, 0.35);
            border-radius: 0 0 24px 24px;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .app-sidebar {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translateX(-103%);
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 45%, #0f766e 100%);
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 18px 0 50px rgba(15, 23, 42, 0.25);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            z-index: 80;
            transition: transform 260ms ease;
        }

        .app-sidebar.open {
            transform: translateX(0);
        }

        .app-sidebar .nav-btn {
            width: 100%;
            padding: 0.72rem 0.8rem;
            border-radius: 12px;
            text-align: left;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 180ms ease;
        }

        .app-sidebar .nav-btn.active {
            background: rgba(255, 255, 255, 0.16);
            color: #fff;
            transform: translateX(2px);
        }

        .app-topbar {
            position: sticky;
            top: 0;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(10px);
        }

        .app-content-wrap {
            flex: 1;
            min-width: 0;
            width: 100%;
        }

        .notif-drawer {
            position: fixed;
            top: 78px;
            right: 18px;
            width: min(390px, calc(100% - 24px));
            max-height: min(70vh, 540px);
            overflow: auto;
            z-index: 130;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: 0 24px 58px rgba(15, 23, 42, 0.24);
            backdrop-filter: blur(8px);
        }

        .garden-3d-shell {
            position: relative;
            border-radius: 24px;
            padding: 2rem;
            min-height: 420px;
            perspective: 1400px;
            overflow: hidden;
            background:
                radial-gradient(850px 320px at 50% -25%, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0)),
                linear-gradient(180deg, #b7e8ff 0%, #dcf7ff 45%, #ddf5df 100%);
        }

        .garden-3d-world {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        .garden-terrain {
            position: absolute;
            inset: auto -5% -28px -5%;
            height: 38%;
            background: linear-gradient(180deg, #8b6d4e 0%, #6a4b37 100%);
            border-radius: 50% 50% 0 0;
            transform: rotateX(62deg) translateZ(-16px);
            box-shadow: inset 0 22px 42px rgba(0, 0, 0, 0.25);
        }

        .tree-3d {
            position: absolute;
            left: 50%;
            bottom: 21%;
            width: 220px;
            height: 290px;
            transform: translateX(-50%) rotateX(8deg);
            transform-style: preserve-3d;
            animation: sway 4.4s ease-in-out infinite;
        }

        .tree-trunk {
            position: absolute;
            left: 50%;
            bottom: 0;
            width: 34px;
            height: 145px;
            border-radius: 16px;
            transform: translateX(-50%) translateZ(22px);
            background: linear-gradient(180deg, #9a6a42, #69442d);
            box-shadow: inset -6px 0 10px rgba(0, 0, 0, 0.2);
        }

        .tree-canopy {
            position: absolute;
            left: 50%;
            border-radius: 999px;
            background: radial-gradient(circle at 35% 30%, #9bf4b4 0%, #2f9d69 65%, #1f7a53 100%);
            filter: drop-shadow(0 16px 26px rgba(25, 97, 66, 0.3));
            transform: translateX(-50%);
        }

        .tree-canopy.l1 {
            width: 175px;
            height: 130px;
            bottom: 120px;
            transform: translateX(-50%) translateZ(44px);
        }

        .tree-canopy.l2 {
            width: 130px;
            height: 100px;
            bottom: 168px;
            transform: translateX(-50%) translateZ(60px);
        }

        .tree-canopy.l3 {
            width: 88px;
            height: 72px;
            bottom: 212px;
            transform: translateX(-50%) translateZ(74px);
        }

        .flower-node {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.45);
            animation: float-advanced 6s ease-in-out infinite;
        }

        .flower-node.f1 {
            left: 18%;
            bottom: 27%;
            background: #ef4444;
        }

        .flower-node.f2 {
            left: 28%;
            bottom: 21%;
            background: #f59e0b;
            animation-delay: 1s;
        }

        .flower-node.f3 {
            right: 22%;
            bottom: 26%;
            background: #8b5cf6;
            animation-delay: 1.8s;
        }

        .flower-node.f4 {
            right: 30%;
            bottom: 20%;
            background: #06b6d4;
            animation-delay: 2.3s;
        }

        .tree-low .tree-canopy {
            background: radial-gradient(circle at 35% 30%, #fde68a 0%, #f59e0b 65%, #d97706 100%);
        }

        .tree-mid .tree-canopy {
            background: radial-gradient(circle at 35% 30%, #bbf7d0 0%, #22c55e 65%, #15803d 100%);
        }

        .tree-high .tree-canopy {
            background: radial-gradient(circle at 35% 30%, #86efac 0%, #16a34a 60%, #166534 100%);
        }

        #google_translate_element {
            position: fixed;
            left: -10000px;
            top: auto;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        body {
            top: 0 !important;
        }

        .skiptranslate iframe,
        .goog-te-banner-frame {
            display: none !important;
        }

        @media (max-width: 1024px) {
            .notif-drawer {
                right: 10px;
                top: 70px;
                width: calc(100% - 20px);
            }
        }

        .app-shell::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(600px 280px at 12% 16%, rgba(20, 184, 166, 0.12), transparent 60%),
                radial-gradient(700px 320px at 88% 8%, rgba(59, 130, 246, 0.12), transparent 58%);
            animation: premiumGlow 14s ease-in-out infinite alternate;
            z-index: 0;
        }

        @keyframes premiumGlow {
            from {
                opacity: 0.65;
                transform: translateY(0);
            }

            to {
                opacity: 1;
                transform: translateY(-8px);
            }
        }

        .app-content-wrap {
            position: relative;
            z-index: 1;
        }

        .list-item {
            animation: fadeIn 260ms ease-out;
        }

        *:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }
    </style>
</head>

<body x-data="app()" x-init="init()">

    <!-- Audio for notification sound -->
    <audio id="notificationSound" class="notification-sound">
        <source src="data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAAA="
            type="audio/wav">
    </audio>

    <!-- LOGIN SCREEN -->
    <template x-if="!isLoggedIn && currentPage === 'login'">
        <div class="auth-shell min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="brand-mark mx-auto mb-4">MG</div>
                    <h1 class="text-4xl font-bold text-white mb-2">MediGarden</h1>
                    <p class="text-green-100">Clinical Medication Management for Families</p>
                </div>

                <div class="auth-card bg-white rounded-3xl shadow-2xl p-8 premium-card">
                    <div class="flex gap-2 mb-6">
                        <button @click="loginTab = 'signin'"
                            :class="loginTab === 'signin' ? 'bg-[#2D9F75] text-white' : 'bg-gray-100'"
                            class="flex-1 py-2 rounded-lg font-semibold transition premium-btn">Sign In</button>
                        <button @click="loginTab = 'signup'"
                            :class="loginTab === 'signup' ? 'bg-[#2D9F75] text-white' : 'bg-gray-100'"
                            class="flex-1 py-2 rounded-lg font-semibold transition premium-btn">Sign Up</button>
                    </div>

                    <!-- Sign In Tab -->
                    <div x-show="loginTab === 'signin'" class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Email</label>
                            <input x-model="auth.email" type="email" placeholder="you@example.com"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Password</label>
                            <input x-model="auth.password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                        </div>
                        <button @click="signIn()"
                            class="w-full bg-[#2D9F75] text-white py-3 rounded-lg font-bold hover:bg-[#258562] transition">Sign
                            In</button>
                        <button @click="signInWithGoogle()"
                            class="w-full border-2 border-gray-300 py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-gray-50 transition">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5">
                            Sign in with Google
                        </button>
                        <p class="text-xs text-gray-500">Email sign-in requires verified email.</p>
                    </div>

                    <!-- Sign Up Tab -->
                    <div x-show="loginTab === 'signup'" class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Name</label>
                            <input x-model="auth.displayName" type="text" placeholder="Your Name"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Email</label>
                            <input x-model="auth.email" type="email" placeholder="you@example.com"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-700">Password</label>
                            <input x-model="auth.password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                        </div>
                        <div class="border rounded-xl p-3 bg-slate-50">
                            <label class="text-sm font-semibold text-gray-700">Phone (optional, OTP verification)</label>
                            <input x-model="auth.phone" type="tel" placeholder="+91XXXXXXXXXX"
                                class="w-full mt-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                            <div class="flex gap-2 mt-2">
                                <input x-model="auth.otp" type="text" placeholder="OTP code"
                                    class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                                <button @click="sendPhoneOtp()" type="button" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold">Send OTP</button>
                                <button @click="verifyPhoneOtp()" type="button" class="px-3 py-2 bg-indigo-500 text-white rounded-lg text-sm font-bold">Verify</button>
                            </div>
                            <p class="text-xs mt-2" :class="auth.phoneVerified ? 'text-green-600' : 'text-gray-500'" x-text="auth.phoneVerified ? 'Phone verified.' : 'Verify phone or use email verification.'"></p>
                            <div id="recaptcha-container" class="mt-2"></div>
                        </div>
                        <button @click="signUp()"
                            class="w-full bg-[#2D9F75] text-white py-3 rounded-lg font-bold hover:bg-[#258562] transition">Create
                            Account</button>
                    </div>
                </div>

                <p class="text-center text-green-100 mt-6">Track schedules, adherence, and family support in one place.
                </p>
            </div>
        </div>
    </template>

    <!-- MAIN APP -->
    <template x-if="isLoggedIn && currentPage !== 'login'">
        <div class="app-shell min-h-screen bg-gradient-to-b from-blue-50 to-green-50">
            <div class="app-layout">
                <aside class="app-sidebar" :class="sidebarOpen ? 'open' : ''">
                    <div class="flex items-center gap-3 pb-2 border-b border-white/20">
                        <div class="brand-mark">MG</div>
                        <div>
                            <h1 class="font-bold text-lg text-white">MediGarden</h1>
                            <p class="text-xs text-slate-200" x-text="displayName"></p>
                        </div>
                    </div>

                    <button @click="goTo('dashboard')" class="nav-btn" :class="currentPage === 'dashboard' ? 'active' : ''"><span x-text="t('nav.dashboard')"></span><span>üè†</span></button>
                    <button @click="goTo('phr')" class="nav-btn" :class="currentPage === 'phr' ? 'active' : ''"><span x-text="t('nav.phr')"></span><span>üìã</span></button>
                    <button @click="goTo('monitoring')" class="nav-btn" :class="currentPage === 'monitoring' ? 'active' : ''"><span x-text="t('nav.monitoring')"></span><span>üì°</span></button>
                    <button @click="goTo('insights')" class="nav-btn" :class="currentPage === 'insights' ? 'active' : ''"><span x-text="t('nav.insights')"></span><span>ü§ñ</span></button>
                    <button @click="goTo('analytics')" class="nav-btn" :class="currentPage === 'analytics' ? 'active' : ''"><span x-text="t('nav.analytics')"></span><span>üìà</span></button>
                    <button @click="goTo('garden')" class="nav-btn" :class="currentPage === 'garden' ? 'active' : ''"><span x-text="t('nav.garden')"></span><span>üåø</span></button>
                    <button @click="goTo('family')" class="nav-btn" :class="currentPage === 'family' ? 'active' : ''"><span x-text="t('nav.family')"></span><span x-text="familyMembers.length"></span></button>
                    <button @click="goTo('alerts')" class="nav-btn" :class="currentPage === 'alerts' ? 'active' : ''"><span x-text="t('nav.alerts')"></span><span x-text="familyAlerts.length"></span></button>
                    <button @click="goTo('profile')" class="nav-btn" :class="currentPage === 'profile' ? 'active' : ''"><span x-text="t('nav.profile')"></span><span>‚öôÔ∏è</span></button>

                    <div class="mt-auto">
                        <button @click="logout()" class="nav-btn bg-red-500/80 border-red-300/30 text-white"><span x-text="t('nav.logout')"></span><span>‚Ü©</span></button>
                    </div>
                </aside>
                <div x-show="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black/30 z-[70] lg:hidden"></div>

                <div class="app-content-wrap">
                    <header class="app-topbar">
                        <div class="flex items-center gap-3">
                            <button @click="sidebarOpen = !sidebarOpen" class="px-3 py-2 border rounded-lg bg-white">‚ò∞</button>
                            <div>
                                <p class="text-sm text-slate-500">MediGarden Control Center</p>
                                <p class="font-bold" x-text="`Welcome, ${displayName}`"></p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="notificationPanelOpen = !notificationPanelOpen" class="relative px-3 py-2 border rounded-lg bg-white font-semibold">
                                Notifications
                                <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs px-1.5 py-0.5 rounded-full" x-show="unreadNotifications > 0" x-text="unreadNotifications"></span>
                            </button>
                            <button @click="goTo('profile')" class="px-3 py-2 border rounded-lg bg-white">Profile</button>
                        </div>
                    </header>
                    <div class="px-2 sm:px-4 pb-10">

            <!-- DASHBOARD PAGE -->
            <template x-if="currentPage === 'dashboard'">
                <main class="w-full px-4 py-6 sm:px-6 space-y-6 sm:space-y-8 pb-20">
                    <!-- Summary Cards - Mobile Optimized -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
                        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                            <div class="flex justify-between items-start">
                                <div class="min-w-0 flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm font-semibold">Today's Medications</p>
                                    <p class="text-2xl sm:text-4xl font-bold text-green-600 mt-1 sm:mt-2"><span
                                            x-text="todayTaken"></span>/<span x-text="todayTotal"></span></p>
                                </div>
                                <div class="text-2xl sm:text-4xl ml-2">üíä</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg border-l-4 border-orange-500">
                            <div class="flex justify-between items-start">
                                <div class="min-w-0 flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm font-semibold">Current Streak</p>
                                    <p class="text-2xl sm:text-4xl font-bold text-orange-600 mt-1 sm:mt-2"
                                        x-text="streak"></p>
                                </div>
                                <div class="text-2xl sm:text-4xl ml-2">üî•</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg border-l-4 border-blue-500">
                            <div class="flex justify-between items-start">
                                <div class="min-w-0 flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm font-semibold">This Week</p>
                                    <p class="text-2xl sm:text-4xl font-bold text-blue-600 mt-1 sm:mt-2"
                                        x-text="weekAdherence + '%'"></p>
                                </div>
                                <div class="text-2xl sm:text-4xl ml-2">üìà</div>
                            </div>
                        </div>

                        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg border-l-4 border-purple-500">
                            <div class="flex justify-between items-start">
                                <div class="min-w-0 flex-1">
                                    <p class="text-gray-600 text-xs sm:text-sm font-semibold">Family Members</p>
                                    <p class="text-2xl sm:text-4xl font-bold text-purple-600 mt-1 sm:mt-2"
                                        x-text="familyMembers.length + 1"></p>
                                </div>
                                <div class="text-2xl sm:text-4xl ml-2">üë•</div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Medications -->
                    <div class="bg-white rounded-2xl p-4 sm:p-8 premium-card">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold gradient-text">Today's Medications</h2>
                            <button @click="openAdd()"
                                class="w-full sm:w-auto bg-[#2D9F75] text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-bold flex items-center justify-center sm:justify-start gap-2 hover:bg-[#258562] premium-btn">
                                + Add Medication
                            </button>
                        </div>
                        <template x-if="meds.length === 0">
                            <div class="text-center py-8 text-gray-500">
                                <p class="text-lg">No medications yet. Add one to get started!</p>
                            </div>
                        </template>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                            <template x-for="med in getTodaysMeds()" :key="med.id">
                                <div :class="med.taken ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'"
                                    class="p-3 sm:p-4 rounded-lg border-2 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 premium-card list-item">
                                    <div class="flex gap-3 items-start flex-1 min-w-0">
                                        <div class="text-2xl flex-shrink-0 float-anim">üíä</div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-bold text-base sm:text-lg truncate" x-text="med.name"></h4>
                                            <p class="text-xs sm:text-sm text-gray-500" x-text="med.time"></p>
                                            <p class="text-xs text-gray-400" x-text="med.dosage || 'Dosage: N/A'"></p>
                                            <p class="text-xs text-purple-600 mt-1"
                                                x-text="'Frequency: ' + getFrequencyLabel(med.frequency)"></p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 w-full sm:w-auto flex-wrap sm:flex-nowrap">
                                        <button @click="openEditMed(med)"
                                            class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-yellow-600 border border-yellow-300 rounded-lg text-xs sm:text-sm font-bold hover:bg-yellow-50 premium-btn">Edit</button>
                                        <button @click="deleteMedication(med.id)"
                                            class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-red-600 border border-red-300 rounded-lg text-xs sm:text-sm font-bold hover:bg-red-50 premium-btn">Delete</button>
                                        <button @click="takeMedicationById(med.id)"
                                            :class="med.taken ? 'bg-green-500 cursor-default' : 'bg-[#2D9F75] hover:bg-[#258562]'"
                                            class="flex-1 sm:flex-none px-3 sm:px-6 py-2 text-white rounded-lg text-xs sm:text-sm font-bold premium-btn"
                                            x-text="med.taken ? 'Done' : 'Take Now'"></button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Family Health Overview -->
                    <div class="bg-white rounded-2xl p-4 sm:p-8 premium-card">
                        <h2 class="text-xl sm:text-2xl font-bold mb-6 gradient-text">Family Health Overview</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6">
                            <template x-if="familyMembers.length === 0">
                                <div class="col-span-full text-center py-8 text-gray-500">
                                    <p class="text-base sm:text-lg">No family members added yet. Visit the Family page
                                        to invite them!</p>
                                </div>
                            </template>
                            <template x-for="member in familyMembers" :key="member.uid">
                                <div class="border-2 border-purple-200 rounded-lg p-3 sm:p-4 bg-purple-50 cursor-pointer premium-card list-item hover-lift"
                                    @click="viewMemberGarden(member.uid)">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="min-w-0 flex-1">
                                            <h4 class="font-bold text-base sm:text-lg truncate"
                                                x-text="member.displayName || member.email"></h4>
                                            <p class="text-xs text-gray-500"
                                                x-text="member.relationship || 'Family Member'"></p>
                                        </div>
                                        <div class="text-xl ml-2"
                                            x-text="getMemberStatus(member.uid) === 'On Track' ? '‚úÖ' : '‚ö†Ô∏è'"></div>
                                    </div>
                                    <div class="space-y-1 sm:space-y-2 text-xs sm:text-sm">
                                        <div class="flex justify-between">
                                            <span>Adherence:</span>
                                            <span class="font-bold text-purple-600"
                                                x-text="getMemberAdherence(member.uid) + '%'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Streak:</span>
                                            <span class="font-bold text-orange-600"
                                                x-text="getMemberStreak(member.uid) + ' days'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Status:</span>
                                            <span class="font-bold"
                                                :class="getMemberStatus(member.uid) === 'On Track' ? 'text-green-600' : 'text-red-600'"
                                                x-text="getMemberStatus(member.uid)"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </main>
            </template>

            <!-- PHR PAGE -->
            <template x-if="currentPage === 'phr'">
                <main class="max-w-7xl mx-auto p-6 space-y-6">
                    <div class="bg-white rounded-2xl p-6 premium-card">
                        <h2 class="text-2xl font-bold gradient-text mb-2" x-text="t('phr.title')"></h2>
                        <p class="text-gray-600 mb-6" x-text="t('phr.subtitle')"></p>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold" x-text="t('phr.type')"></label>
                                <select x-model="phrForm.type"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg">
                                    <option value="Medical History" x-text="t('phr.medicalHistory')"></option>
                                    <option value="Lab Result" x-text="t('phr.labResult')"></option>
                                    <option value="Allergy" x-text="t('phr.allergy')"></option>
                                    <option value="Vaccination" x-text="t('phr.vaccination')"></option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-semibold" x-text="t('phr.date')"></label>
                                <input x-model="phrForm.date" type="date"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-semibold" x-text="t('phr.titleField')"></label>
                                <input x-model="phrForm.title"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-semibold" x-text="t('phr.notes')"></label>
                                <textarea x-model="phrForm.notes"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm font-semibold" x-text="t('phr.upload')"></label>
                                <input @change="onPhrFileChange($event)" type="file"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                                <p class="text-xs text-gray-500 mt-1" x-text="phrForm.fileName || t('phr.noFile')"></p>
                            </div>
                        </div>
                        <button @click="addPhrRecord()"
                            class="mt-4 px-6 py-2 bg-[#2D9F75] text-white rounded-lg font-bold hover:bg-[#258562]"
                            x-text="t('phr.addRecord')"></button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 premium-card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold" x-text="t('phr.records')"></h3>
                            <span class="text-sm text-gray-500"
                                x-text="phrRecords.length + ' ' + t('phr.total')"></span>
                        </div>
                        <template x-if="phrRecords.length === 0">
                            <p class="text-gray-500" x-text="t('phr.empty')"></p>
                        </template>
                        <div class="space-y-3">
                            <template x-for="record in phrRecords" :key="record.id">
                                <div
                                    class="border rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                    <div>
                                        <p class="text-xs text-gray-500"
                                            x-text="record.type + ' ‚Ä¢ ' + (record.date || '-')"></p>
                                        <p class="font-bold" x-text="record.title"></p>
                                        <p class="text-sm text-gray-600" x-text="record.notes"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="downloadPhrRecord(record.id)"
                                            class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold"
                                            x-text="t('phr.download')"></button>
                                        <button @click="deletePhrRecord(record.id)"
                                            class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-semibold"
                                            x-text="t('phr.delete')"></button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </main>
            </template>

            <!-- REMOTE MONITORING PAGE -->
            <template x-if="currentPage === 'monitoring'">
                <main class="max-w-7xl mx-auto p-6 space-y-6">
                    <div class="bg-white rounded-2xl p-6 premium-card">
                        <h2 class="text-2xl font-bold gradient-text mb-2" x-text="t('monitoring.title')"></h2>
                        <p class="text-gray-600 mb-6" x-text="t('monitoring.subtitle')"></p>
                        <div class="flex flex-wrap gap-3 mb-6">
                            <button @click="togglePedometerTracking()"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold"
                                x-text="stepTrackingActive ? 'Stop Pedometer' : 'Connect Pedometer'"></button>
                            <button @click="connectHeartRateMonitor()"
                                class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold"
                                x-text="heartRateConnected ? 'Heart Rate Connected' : 'Connect Heart Rate (Bluetooth)'"></button>
                            <button @click="connectBpMonitor()"
                                class="px-4 py-2 bg-violet-500 text-white rounded-lg font-semibold"
                                x-text="bpConnected ? 'BP Connected' : 'Connect BP Monitor (Bluetooth)'"></button>
                            <button @click="toggleRemoteMonitoring()"
                                :class="remoteMonitoringActive ? 'bg-red-500' : 'bg-green-600'"
                                class="px-4 py-2 text-white rounded-lg font-semibold">
                                <span
                                    x-text="remoteMonitoringActive ? t('monitoring.stop') : t('monitoring.start')"></span>
                            </button>
                        </div>
                        <div class="grid sm:grid-cols-3 gap-3 mb-4">
                            <div class="p-3 rounded-xl bg-slate-50 border">
                                <p class="text-xs text-gray-500">Pedometer</p>
                                <p class="font-bold" :class="stepTrackingActive ? 'text-green-600' : 'text-gray-600'" x-text="stepTrackingActive ? 'Connected' : 'Disconnected'"></p>
                            </div>
                            <div class="p-3 rounded-xl bg-slate-50 border">
                                <p class="text-xs text-gray-500">Heart Rate Device</p>
                                <p class="font-bold" :class="heartRateConnected ? 'text-green-600' : 'text-gray-600'" x-text="heartRateConnected ? 'Connected' : 'Disconnected'"></p>
                            </div>
                            <div class="p-3 rounded-xl bg-slate-50 border">
                                <p class="text-xs text-gray-500">BP Device</p>
                                <p class="font-bold" :class="bpConnected ? 'text-green-600' : 'text-gray-600'" x-text="bpConnected ? 'Connected' : 'Disconnected'"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                            <div class="p-4 bg-red-50 rounded-xl">
                                <p class="text-xs text-gray-500">Heart Rate</p>
                                <p class="text-2xl font-bold text-red-600" x-text="vitals.heartRate + ' bpm'"></p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl">
                                <p class="text-xs text-gray-500">Blood Pressure</p>
                                <p class="text-2xl font-bold text-blue-600" x-text="vitals.bloodPressure"></p>
                            </div>
                            <div class="p-4 bg-cyan-50 rounded-xl">
                                <p class="text-xs text-gray-500">SpO2</p>
                                <p class="text-2xl font-bold text-cyan-600" x-text="vitals.spo2 + '%'"></p>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl">
                                <p class="text-xs text-gray-500">Temperature</p>
                                <p class="text-2xl font-bold text-amber-600" x-text="vitals.temperature + ' C'"></p>
                            </div>
                            <div class="p-4 bg-emerald-50 rounded-xl">
                                <p class="text-xs text-gray-500">Steps</p>
                                <p class="text-2xl font-bold text-emerald-600" x-text="vitals.steps"></p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-4"
                            x-text="'Last sync: ' + (vitals.lastUpdated ? new Date(vitals.lastUpdated).toLocaleString() : '-')">
                        </p>
                    </div>
                </main>
            </template>

            <!-- AI INSIGHTS PAGE -->
            <template x-if="currentPage === 'insights'">
                <main class="max-w-7xl mx-auto p-6 space-y-6">
                    <div class="bg-white rounded-2xl p-6 premium-card">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold gradient-text" x-text="t('insights.title')"></h2>
                            <button @click="runAiInsights()"
                                class="px-4 py-2 bg-[#2D9F75] text-white rounded-lg font-semibold"
                                x-text="t('insights.refresh')"></button>
                        </div>
                        <p class="text-gray-600 mb-6" x-text="t('insights.subtitle')"></p>
                        <div class="grid sm:grid-cols-3 gap-4 mb-6">
                            <div class="p-4 rounded-xl border">
                                <p class="text-xs text-gray-500">Adherence Risk</p>
                                <p class="text-3xl font-bold"
                                    :class="adherenceRiskScore > 70 ? 'text-red-600' : adherenceRiskScore > 40 ? 'text-yellow-600' : 'text-green-600'"
                                    x-text="adherenceRiskScore + '%'"></p>
                            </div>
                            <div class="p-4 rounded-xl border">
                                <p class="text-xs text-gray-500">Weekly Adherence</p>
                                <p class="text-3xl font-bold text-blue-600" x-text="weekAdherence + '%'"></p>
                            </div>
                            <div class="p-4 rounded-xl border">
                                <p class="text-xs text-gray-500">Vitals Risk Flags</p>
                                <p class="text-3xl font-bold text-purple-600" x-text="vitalsRiskFlags"></p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <template x-if="aiInsights.length === 0">
                                <p class="text-gray-500" x-text="t('insights.empty')"></p>
                            </template>
                            <template x-for="ins in aiInsights" :key="ins.id">
                                <div class="rounded-xl p-4 border"
                                    :class="ins.level === 'high' ? 'bg-red-50 border-red-200' : ins.level === 'medium' ? 'bg-yellow-50 border-yellow-200' : 'bg-green-50 border-green-200'">
                                    <p class="font-bold" x-text="ins.title"></p>
                                    <p class="text-sm text-gray-700 mt-1" x-text="ins.message"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </main>
            </template>

            <!-- ANALYTICS PAGE -->
            <template x-if="currentPage === 'analytics'">
                <main class="max-w-7xl mx-auto p-6 space-y-6">
                    <div class="bg-white rounded-2xl p-6 premium-card">
                        <h2 class="text-2xl font-bold gradient-text mb-2" x-text="t('analytics.title')"></h2>
                        <p class="text-gray-600 mb-6" x-text="t('analytics.subtitle')"></p>
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="p-4 rounded-xl bg-slate-50">
                                <p class="text-xs text-gray-500">Users</p>
                                <p class="text-3xl font-bold" x-text="populationMetrics.total"></p>
                            </div>
                            <div class="p-4 rounded-xl bg-green-50">
                                <p class="text-xs text-gray-500">Avg Adherence</p>
                                <p class="text-3xl font-bold text-green-600"
                                    x-text="populationMetrics.avgAdherence + '%'"></p>
                            </div>
                            <div class="p-4 rounded-xl bg-blue-50">
                                <p class="text-xs text-gray-500">High Risk</p>
                                <p class="text-3xl font-bold text-blue-600" x-text="populationMetrics.highRiskCount">
                                </p>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-3 gap-4">
                            <div class="border rounded-xl p-4">
                                <h3 class="font-bold mb-3">By Age Group</h3>
                                <template x-for="row in analyticsByAge" :key="row.label">
                                    <div class="flex justify-between text-sm py-1">
                                        <span x-text="row.label"></span>
                                        <span class="font-semibold" x-text="row.value + '%'"></span>
                                    </div>
                                </template>
                            </div>
                            <div class="border rounded-xl p-4">
                                <h3 class="font-bold mb-3">By Region</h3>
                                <template x-for="row in analyticsByRegion" :key="row.label">
                                    <div class="flex justify-between text-sm py-1">
                                        <span x-text="row.label"></span>
                                        <span class="font-semibold" x-text="row.value + '%'"></span>
                                    </div>
                                </template>
                            </div>
                            <div class="border rounded-xl p-4">
                                <h3 class="font-bold mb-3">By Condition</h3>
                                <template x-for="row in analyticsByCondition" :key="row.label">
                                    <div class="flex justify-between text-sm py-1">
                                        <span x-text="row.label"></span>
                                        <span class="font-semibold" x-text="row.value + '%'"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </main>
            </template>

            <!-- GARDEN PAGE -->
            <template x-if="currentPage === 'garden'">
                <main class="max-w-7xl mx-auto p-6 space-y-6">
                    <div class="bg-white rounded-2xl p-8 premium-card">
                        <h2 class="text-4xl font-bold mb-2 gradient-text">Your 3D Wellness Garden</h2>
                        <p class="text-gray-600 mb-6 text-lg">A real-time visual twin of your adherence and consistency.</p>

                        <div class="garden-3d-shell">
                            <div class="garden-3d-world">
                                <div class="absolute inset-0 pointer-events-none">
                                    <div class="absolute top-8 left-12 w-24 h-24 bg-white/60 blur-2xl rounded-full"></div>
                                    <div class="absolute top-12 right-16 w-20 h-20 bg-cyan-100/70 blur-2xl rounded-full"></div>
                                </div>

                                <div class="tree-3d" :class="weekAdherence >= 85 ? 'tree-high' : weekAdherence >= 60 ? 'tree-mid' : 'tree-low'">
                                    <div class="tree-trunk"></div>
                                    <div class="tree-canopy l1"></div>
                                    <div class="tree-canopy l2"></div>
                                    <div class="tree-canopy l3"></div>
                                </div>

                                <div class="flower-node f1"></div>
                                <div class="flower-node f2"></div>
                                <div class="flower-node f3"></div>
                                <div class="flower-node f4"></div>
                                <div class="garden-terrain"></div>
                            </div>
                        </div>

                        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                            <div class="bg-slate-50 rounded-xl p-4 border">
                                <p class="text-xs text-gray-500">Current Adherence</p>
                                <p class="text-3xl font-bold text-emerald-700" x-text="weekAdherence + '%'"></p>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-4 border">
                                <p class="text-xs text-gray-500">Tree Stage</p>
                                <p class="text-2xl font-bold" x-text="weekAdherence >= 85 ? 'Flourishing' : weekAdherence >= 60 ? 'Growing' : 'Early Growth'"></p>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-4 border">
                                <p class="text-xs text-gray-500">Streak</p>
                                <p class="text-3xl font-bold text-blue-700" x-text="streak + ' days'"></p>
                            </div>
                            <div class="bg-slate-50 rounded-xl p-4 border">
                                <p class="text-xs text-gray-500">Total Doses</p>
                                <p class="text-3xl font-bold text-purple-700" x-text="totalDoses"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-8 premium-card">
                        <h3 class="text-2xl font-bold mb-4">Medication History</h3>
                        <div class="flex justify-between items-center mb-6">
                            <button @click="offsetMonth(-1)" class="px-4 py-2 bg-gray-200 rounded-lg">‚Üê Previous</button>
                            <h4 class="text-xl font-bold" x-text="currentMonthLabel"></h4>
                            <button @click="offsetMonth(1)" class="px-4 py-2 bg-gray-200 rounded-lg">Next ‚Üí</button>
                        </div>
                        <div class="grid grid-cols-7 gap-2">
                            <template x-for="day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']">
                                <div class="text-center font-bold text-gray-600" x-text="day"></div>
                            </template>
                            <template x-for="offset in calendarDays">
                                <div :class="offset.markerClass + ' p-3 rounded-lg text-center font-semibold'">
                                    <div x-text="offset.day"></div>
                                    <div class="text-xs" x-text="offset.markerText"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </main>
            </template>

    <!-- FAMILY PAGE -->
    <template x-if="currentPage === 'family'">
        <main class="max-w-7xl mx-auto p-6 space-y-8">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Add Family Member Card -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl p-8 sticky top-24 space-y-6 premium-card">
                        <div>
                            <h3 class="text-2xl font-bold mb-4 gradient-text">Family Circle</h3>

                            <div>
                                <label class="text-sm font-semibold text-gray-700">Your Share Code</label>
                                <div class="flex gap-2 mt-2">
                                    <input readonly x-model="uid"
                                        class="flex-1 px-3 py-2 border rounded-lg bg-gray-50 font-mono text-sm premium-input" />
                                    <button @click="copyShareCode()"
                                        class="px-4 py-2 bg-[#2D9F75] text-white rounded-lg font-bold premium-btn">Copy</button>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div>
                            <label class="text-sm font-semibold text-gray-700">Add Family Member</label>
                            <p class="text-xs text-gray-500 mb-3">Ask them for their Share Code</p>
                            <div class="flex gap-2 mt-2">
                                <input x-model="inviteUid" placeholder="Enter code"
                                    class="flex-1 px-3 py-2 border rounded-lg font-mono text-sm premium-input" />
                                <button @click="addFamilyMember()"
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg font-bold premium-btn">+</button>
                            </div>
                        </div>

                        <hr>

                        <button
                            @click="async () => { const snap = await firebase.database().ref('users/' + this.uid + '/family').once('value'); await this.loadFamilyList(snap.val() || {}); await this.loadFamilyData(); alert('Family data refreshed!'); }"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600">üîÑ
                            Refresh Family Data</button>

                        <hr>

                        <!-- Debug Info -->
                        <div class="bg-gray-50 p-3 rounded-lg text-xs">
                            <p class="font-bold mb-2">Debug Info:</p>
                            <p><span class="font-semibold">Family Members:</span> <span
                                    x-text="familyMembers.length"></span></p>
                            <p><span class="font-semibold">Data Loaded:</span> <span
                                    x-text="Object.keys(familyData).length"></span></p>
                            <p class="text-gray-600 mt-1">Open browser console (F12) for detailed logs</p>
                        </div>

                        <hr>

                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-3 block">Set Relationship</label>
                            <div class="space-y-2">
                                <button @click="relationshipFilter = 'all'"
                                    :class="relationshipFilter === 'all' ? 'bg-[#2D9F75] text-white' : 'bg-gray-100'"
                                    class="w-full py-2 rounded-lg font-semibold">All Members</button>
                                <button @click="relationshipFilter = 'spouse'"
                                    :class="relationshipFilter === 'spouse' ? 'bg-blue-500 text-white' : 'bg-gray-100'"
                                    class="w-full py-2 rounded-lg font-semibold">Spouse</button>
                                <button @click="relationshipFilter = 'parent'"
                                    :class="relationshipFilter === 'parent' ? 'bg-purple-500 text-white' : 'bg-gray-100'"
                                    class="w-full py-2 rounded-lg font-semibold">Parent</button>
                                <button @click="relationshipFilter = 'child'"
                                    :class="relationshipFilter === 'child' ? 'bg-pink-500 text-white' : 'bg-gray-100'"
                                    class="w-full py-2 rounded-lg font-semibold">Child</button>
                                <button @click="relationshipFilter = 'sibling'"
                                    :class="relationshipFilter === 'sibling' ? 'bg-yellow-500 text-white' : 'bg-gray-100'"
                                    class="w-full py-2 rounded-lg font-semibold">Sibling</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Family Members List -->
                <div class="lg:col-span-2">
                    <h3 class="text-2xl font-bold mb-6 gradient-text">Members (<span
                            x-text="filteredFamilyMembers.length + 1"></span>)</h3>

                    <!-- Current User -->
                    <div
                        class="bg-gradient-to-r from-[#2D9F75] to-green-400 text-white rounded-2xl p-6 mb-4 premium-card">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-xl font-bold" x-text="displayName"></h4>
                                <p class="text-green-100" x-text="userEmail"></p>
                                <p class="text-xs mt-2 opacity-75">(You)</p>
                            </div>
                            <div class="text-4xl font-bold">U</div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs opacity-75">Health Score</p>
                                <p class="text-2xl font-bold" x-text="Math.round(healthScore) + '%'"></p>
                            </div>
                            <div>
                                <p class="text-xs opacity-75">Streak</p>
                                <p class="text-2xl font-bold" x-text="streak + ' days'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Family Members -->
                    <div class="space-y-4">
                        <template x-for="member in filteredFamilyMembers" :key="member.uid">
                            <div class="bg-white rounded-2xl p-6 border-2 border-purple-200 premium-card list-item">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex gap-4 items-start flex-1">
                                        <div class="text-3xl" x-text="getMemberEmoji(member.uid)"></div>
                                        <div class="flex-1">
                                            <h4 class="text-lg font-bold"
                                                x-text="member.displayName || member.email || member.uid"></h4>
                                            <p class="text-sm text-gray-500" x-text="member.email || ''"></p>
                                            <p class="text-xs text-purple-600 mt-1"
                                                x-text="member.relationship || 'Family Member'"></p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="openSetRelationship(member.uid)"
                                            class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm font-bold hover:bg-blue-600 premium-btn">Set</button>
                                        <button @click="removeFamilyMember(member.uid)"
                                            class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm font-bold hover:bg-red-600 premium-btn">Remove</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4 pt-4 border-t">
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500">Adherence</p>
                                        <p class="text-lg font-bold" x-text="getMemberAdherence(member.uid) + '%'"></p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500">Streak</p>
                                        <p class="text-lg font-bold" x-text="getMemberStreak(member.uid) + ' days'"></p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500">Status</p>
                                        <p class="text-lg font-bold"
                                            :class="getMemberStatus(member.uid) === 'On Track' ? 'text-green-600' : 'text-red-600'"
                                            x-text="getMemberStatus(member.uid)"></p>
                                    </div>
                                </div>

                                <button @click="viewMemberGarden(member.uid)"
                                    class="w-full mt-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200 premium-btn">View
                                    Garden</button>
                            </div>
                        </template>

                        <template x-if="filteredFamilyMembers.length === 0">
                            <div class="text-center py-8 bg-gray-50 rounded-2xl">
                                <p class="text-gray-500 text-lg">No family members yet</p>
                                <p class="text-sm text-gray-400">Share your code above to invite them</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </main>
    </template>

    <!-- ALERTS PAGE -->
    <template x-if="currentPage === 'alerts'">
        <main class="max-w-7xl mx-auto p-6">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-3xl font-bold mb-6">Family Alerts & Notifications</h2>

                <template x-if="familyAlerts.length === 0">
                    <div class="text-center py-12">
                        <p class="text-4xl mb-4">üòä</p>
                        <p class="text-gray-500 text-lg">All family members are on track!</p>
                        <p class="text-sm text-gray-400">You'll see alerts here if anyone needs support</p>
                    </div>
                </template>

                <div class="space-y-4">
                    <template x-for="alert in familyAlerts" :key="alert.id">
                        <div :class="alert.severity === 'critical' ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50'"
                            class="border-2 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg" x-text="alert.memberName"></h4>
                                    <p class="text-gray-600 mt-1" x-text="alert.message"></p>
                                    <p class="text-xs text-gray-500 mt-2"
                                        x-text="'Last updated: ' + new Date(alert.timestamp).toLocaleString()"></p>
                                </div>
                                <div :class="alert.severity === 'critical' ? 'text-red-600' : 'text-yellow-600'"
                                    class="text-2xl font-bold" x-text="alert.severity === 'critical' ? '!' : '‚ö°'"></div>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button @click="markAlertResolved(alert.id)"
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600">Mark
                                    Resolved</button>
                                <button @click="sendEncouragementMessage(alert.memberId)"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-bold hover:bg-blue-600">Send
                                    Support Message</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </main>
    </template>

    <!-- PROFILE PAGE -->
    <template x-if="currentPage === 'profile'">
        <main class="max-w-7xl mx-auto p-6">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Profile Card -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl p-8 sticky top-24 premium-card">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4 float-anim">üë§</div>
                            <h3 class="text-2xl font-bold gradient-text" x-text="displayName"></h3>
                            <p class="text-gray-500 text-sm mt-2" x-text="userEmail"></p>
                        </div>

                        <div
                            class="bg-gradient-to-r from-[#2D9F75] to-green-400 text-white rounded-lg p-4 text-center mb-6 premium-card">
                            <p class="text-xs opacity-75">Overall Health Score</p>
                            <p class="text-4xl font-bold" x-text="Math.round(healthScore) + '%'"></p>
                        </div>

                        <div class="space-y-2 mb-6">
                            <div class="flex justify-between p-3 bg-blue-50 rounded-lg premium-card">
                                <span class="font-semibold">üî• Streak</span>
                                <span class="font-bold text-blue-600" x-text="streak + ' days'"></span>
                            </div>
                            <div class="flex justify-between p-3 bg-green-50 rounded-lg premium-card">
                                <span class="font-semibold">üå≥ Week Adherence</span>
                                <span class="font-bold text-green-600" x-text="weekAdherence + '%'"></span>
                            </div>
                            <div class="flex justify-between p-3 bg-purple-50 rounded-lg premium-card">
                                <span class="font-semibold">üíä Total Doses</span>
                                <span class="font-bold text-purple-600" x-text="totalDoses"></span>
                            </div>
                        </div>

                        <hr class="my-6">

                        <div class="space-y-3 mb-6">
                            <p class="text-sm font-semibold text-gray-700 mb-3">Account Actions</p>
                            <button @click="currentPage = 'dashboard'"
                                class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 premium-btn">
                                ‚Üê Back to Dashboard
                            </button>
                            <button @click="logout()"
                                class="w-full px-4 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 premium-btn">
                                Logout
                            </button>
                        </div>

                        <hr class="my-6">

                    </div>
                </div>

                <!-- Settings & App Installation -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Settings Card -->
                    <div class="bg-white rounded-2xl p-8 premium-card">
                        <h3 class="text-2xl font-bold mb-6 gradient-text">‚öôÔ∏è Settings</h3>

                        <div class="space-y-6">
                            <!-- Display Name -->
                            <div>
                                <label class="text-sm font-semibold text-gray-700">Display Name</label>
                                <input x-model="profile.displayName" placeholder="Enter your name"
                                    class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                            </div>

                            <div>
                                <label class="text-sm font-semibold text-gray-700"
                                    x-text="t('profile.language')"></label>
                                <select x-model="settings.language"
                                    class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg">
                                    <option value="en">English</option>
                                    <option value="hi">Hindi</option>
                                    <option value="ta">Tamil</option>
                                </select>
                            </div>

                            <div class="grid md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Age</label>
                                    <input x-model="profile.age" type="number" min="1" max="120"
                                        class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg" />
                                </div>
                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Region</label>
                                    <input x-model="profile.region" placeholder="e.g., South"
                                        class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg" />
                                </div>
                                <div>
                                    <label class="text-sm font-semibold text-gray-700">Condition</label>
                                    <input x-model="profile.condition" placeholder="e.g., Diabetes"
                                        class="w-full mt-2 px-4 py-3 border-2 border-gray-200 rounded-lg" />
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="border-t pt-6">
                                <h4 class="font-semibold mb-4">Notification Settings</h4>
                                <button @click="requestNotificationPermission()"
                                    class="w-full px-4 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 mb-2">
                                    <span
                                        x-text="notifPermissionText === 'granted' ? 'Notifications Enabled' : 'Enable Notifications'"></span>
                                </button>
                                <p class="text-xs text-gray-500 mb-4" x-text="'Status: ' + notifPermissionText"></p>

                                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer mb-3">
                                    <input type="checkbox" x-model="settings.medicationReminders" class="w-5 h-5" />
                                    <span class="font-semibold">Medication Reminders</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer mb-3">
                                    <input type="checkbox" x-model="settings.familyAlerts" class="w-5 h-5" />
                                    <span class="font-semibold">Family Alerts</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer">
                                    <input type="checkbox" x-model="settings.soundEnabled" class="w-5 h-5" />
                                    <span class="font-semibold">Sound Alerts</span>
                                </label>
                            </div>

                            <!-- Save Settings -->
                            <button @click="updateProfile()"
                                class="w-full px-6 py-3 bg-[#2D9F75] text-white rounded-lg font-bold hover:bg-[#258562] transition">Save
                                Settings</button>
                        </div>
                    </div>

                    <!-- Install as App Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-6">Install as App</h3>

                        <template x-if="installPrompt">
                            <div class="space-y-4">
                                <p class="text-gray-600">Install MediGarden as a native app on your device. Get instant
                                    access, work offline, and receive notifications!</p>

                                <div
                                    class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-lg p-4 space-y-3">
                                    <p class="font-semibold text-green-700">App Benefits:</p>
                                    <ul class="space-y-2 text-sm">
                                        <li class="flex items-center gap-2">
                                            <span class="text-green-600">‚úì</span>
                                            <span>Native app experience with fast loading</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span class="text-green-600">‚úì</span>
                                            <span>Works offline for local access</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span class="text-green-600">‚úì</span>
                                            <span>Medication Reminders</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span class="text-green-600">‚úì</span>
                                            <span>Instant access from home screen</span>
                                        </li>
                                        <li class="flex items-center gap-2">
                                            <span class="text-green-600">‚úì</span>
                                            <span>No app store required</span>
                                        </li>
                                    </ul>
                                </div>

                                <button @click="installApp()"
                                    class="w-full px-6 py-4 bg-gradient-to-r from-[#2D9F75] to-green-400 text-white rounded-lg font-bold hover:shadow-lg transition text-lg">Install
                                    App Now</button>

                                <p class="text-xs text-gray-500 text-center">Quick installation ‚Ä¢ No additional setup
                                    needed</p>
                            </div>
                        </template>

                        <template x-if="!installPrompt">
                            <div class="space-y-4">
                                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                    <p class="text-blue-700 font-semibold">App Installation</p>
                                    <p class="text-sm text-blue-600 mt-2">You can install this app as follows:</p>
                                    <ul class="text-sm text-blue-600 mt-2 space-y-1 ml-4">
                                        <li><strong>Android:</strong> Open Chrome menu (‚ãÆ) ‚Üí "Install app"</li>
                                        <li><strong>iOS:</strong> Tap Share ‚Üí "Add to Home Screen"</li>
                                        <li><strong>Desktop:</strong> Click the install icon in address bar</li>
                                    </ul>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- About Card -->
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h3 class="text-2xl font-bold mb-4">About MediGarden</h3>
                        <div class="space-y-3 text-gray-600 text-sm">
                            <p>MediGarden is your personal family health management system designed to help you and your
                                loved ones stay on track with medications.</p>
                            <p><strong>Features:</strong></p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Track daily medications with reminders</li>
                                <li>Monitor family members' adherence</li>
                                <li>Interactive garden visualization</li>
                                <li>Custom medication frequencies</li>
                                <li>Smart health analytics</li>
                                <li>Push notifications & alerts</li>
                            </ul>
                            <hr class="my-4">
                            <p class="text-xs text-gray-500 text-center">
                                MediGarden v1.0 | Your trusted medication companion<br>
                                <strong>Created by Korada Tanvi</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </template>

    <!-- Member Garden View Modal -->
    <template x-if="viewingMemberGarden">
        <div class="fixed inset-0 bg-black/60 z-[150] flex items-center justify-center p-4">
            <div @click.away="viewingMemberGarden = null" class="bg-white w-full max-w-2xl rounded-2xl p-8 relative shadow-2xl max-h-[85vh] overflow-y-auto">
                <button @click="viewingMemberGarden = null" class="absolute top-4 right-4 text-gray-500 text-xl font-bold">‚úï</button>
                <h3 class="text-2xl font-bold mb-4" x-text="viewingMemberName + &quot;'s Garden&quot;"></h3>

                <div class="garden-soil rounded-2xl p-10 text-center relative overflow-hidden mb-6">
                    <template x-if="viewingMemberAdherence >= 80"><div class="text-7xl mb-2 garden-plant">üå≥</div></template>
                    <template x-if="viewingMemberAdherence >= 55 && viewingMemberAdherence < 80"><div class="text-6xl mb-2 garden-plant">üå≤</div></template>
                    <template x-if="viewingMemberAdherence < 55"><div class="text-5xl mb-2 garden-plant">üå±</div></template>
                    <p class="text-white font-bold text-lg" x-text="'Weekly Adherence: ' + viewingMemberAdherence + '%'"></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600">Streak</p>
                        <p class="text-xl font-bold" x-text="viewingMemberStreak + ' days'"></p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-gray-600">Status</p>
                        <p class="text-xl font-bold" :class="viewingMemberStatus === 'On Track' ? 'text-green-600' : 'text-red-600'" x-text="viewingMemberStatus"></p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <p class="text-sm text-gray-600">Overall</p>
                        <p class="text-xl font-bold" x-text="viewingMemberAdherence + '%'"></p>
                    </div>
                </div>
            </div>
        </div>
    </template>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <div id="google_translate_element"></div>

    <div class="notif-drawer" x-show="notificationPanelOpen" x-transition>
        <div class="p-4 border-b flex items-center justify-between">
            <h3 class="font-bold text-lg">Notifications</h3>
            <button @click="markAllNotificationsRead()" class="text-sm px-3 py-1 border rounded-lg">Mark all read</button>
        </div>
        <div class="p-4 space-y-3">
            <template x-if="notificationLog.length === 0">
                <p class="text-sm text-gray-500">No notifications yet.</p>
            </template>
            <template x-for="n in notificationLog" :key="n.id">
                <div class="p-3 rounded-lg border" :class="n.read ? 'bg-white' : 'bg-emerald-50 border-emerald-200'">
                    <p class="font-semibold" x-text="n.title"></p>
                    <p class="text-sm text-gray-600 mt-1" x-text="n.message"></p>
                    <p class="text-xs text-gray-400 mt-1" x-text="new Date(n.ts).toLocaleString()"></p>
                </div>
            </template>
        </div>
    </div>

    <!-- MODALS -->
    <div x-show="modal" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 backdrop-blur-sm"
        x-transition>
        <div @click.away="modal = null"
            class="bg-white w-full max-w-md rounded-2xl p-6 relative shadow-2xl max-h-96 overflow-y-auto">
            <button @click="modal = null" class="absolute top-4 right-4 text-gray-500 text-xl font-bold">‚úï</button>

            <!-- Add/Edit Medication Modal -->
            <div x-show="modal === 'add' || modal === 'edit'">
                <h3 class="text-2xl font-bold mb-4" x-text="modal === 'add' ? 'Add Medication' : 'Edit Medication'">
                </h3>
                <form @submit.prevent="submitAdd" class="space-y-4">
                    <div>
                        <label class="text-sm font-semibold">Medication Name *</label>
                        <input x-model="form.name" required placeholder="e.g., Aspirin"
                            class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                    </div>

                    <div>
                        <label class="text-sm font-semibold">Time *</label>
                        <input x-model="form.time" type="time" required
                            class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                    </div>

                    <div>
                        <label class="text-sm font-semibold">Dosage</label>
                        <input x-model="form.dosage" placeholder="e.g., 1 tablet, 5ml"
                            class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none" />
                    </div>

                    <div>
                        <label class="text-sm font-semibold">Frequency</label>
                        <div class="space-y-2 mt-2">
                            <label class="flex items-center gap-2">
                                <input type="radio" x-model="form.frequency.type" value="daily" class="w-4 h-4" />
                                <span>Daily</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="radio" x-model="form.frequency.type" value="custom" class="w-4 h-4" />
                                <span>Custom</span>
                            </label>
                        </div>
                    </div>

                    <template x-if="form.frequency.type === 'custom'">
                        <div class="space-y-2 border-t pt-4">
                            <div>
                                <label class="text-sm font-semibold">Times per day</label>
                                <input x-model.number="form.frequency.timesPerDay" type="number" min="1" max="10"
                                    class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                            </div>
                            <div>
                                <label class="text-sm font-semibold">Duration</label>
                                <div class="flex gap-2 mt-1">
                                    <input x-model.number="form.frequency.duration" type="number" min="1"
                                        placeholder="30" class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg" />
                                    <select x-model="form.frequency.durationUnit"
                                        class="px-4 py-2 border-2 border-gray-200 rounded-lg">
                                        <option value="days">Days</option>
                                        <option value="weeks">Weeks</option>
                                        <option value="months">Months</option>
                                        <option value="years">Years</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div>
                        <label class="text-sm font-semibold">Notes</label>
                        <textarea x-model="form.notes" placeholder="e.g., Take with food"
                            class="w-full mt-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-[#2D9F75] focus:outline-none"></textarea>
                    </div>

                    <div class="flex gap-3 justify-end pt-4">
                        <button type="button" @click="modal = null"
                            class="px-4 py-2 border-2 border-gray-300 rounded-lg font-bold">Cancel</button>
                        <button type="submit"
                            class="px-4 py-2 bg-[#2D9F75] text-white rounded-lg font-bold hover:bg-[#258562]"
                            x-text="modal === 'add' ? 'Add' : 'Update'"></button>
                    </div>
                </form>
            </div>

            <!-- Set Relationship Modal -->
            <div x-show="modal === 'setRelationship'">
                <h3 class="text-2xl font-bold mb-4">Set Relationship</h3>
                <div class="space-y-3">
                    <button @click="setMemberRelationship('spouse'); modal = null"
                        class="w-full py-3 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200">üë∞
                        Spouse</button>
                    <button @click="setMemberRelationship('parent'); modal = null"
                        class="w-full py-3 bg-purple-100 text-purple-700 rounded-lg font-bold hover:bg-purple-200">üë¥
                        Parent</button>
                    <button @click="setMemberRelationship('child'); modal = null"
                        class="w-full py-3 bg-pink-100 text-pink-700 rounded-lg font-bold hover:bg-pink-200">üëß
                        Child</button>
                    <button @click="setMemberRelationship('sibling'); modal = null"
                        class="w-full py-3 bg-yellow-100 text-yellow-700 rounded-lg font-bold hover:bg-yellow-200">üë¶
                        Sibling</button>
                    <button @click="setMemberRelationship('friend'); modal = null"
                        class="w-full py-3 bg-green-100 text-green-700 rounded-lg font-bold hover:bg-green-200">üë´
                        Friend</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Reminders -->
    <div class="reminder-panel" x-show="inAppReminders.length > 0" x-transition>
        <template x-for="r in inAppReminders" :key="r.medId">
            <div class="bg-white p-4 rounded-lg mb-3 shadow-lg border-l-4 border-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-lg" x-text="r.name"></div>
                        <div class="text-xs text-gray-400" x-text="r.time"></div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="handleReminderYes(r)"
                            class="px-3 py-1 bg-green-500 text-white rounded font-bold text-sm">‚úì Taken</button>
                        <button @click="handleReminderMissed(r)"
                            class="px-3 py-1 bg-red-500 text-white rounded font-bold text-sm">‚úï Missed</button>
                        <button @click="snoozeReminder(r, 10)" class="px-3 py-1 border rounded font-bold text-sm">‚è∞
                            Snooze</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- PWA Manifest & Service Worker -->
    <script>
        const manifest = {
            name: "MediGarden - Family Health Management",
            short_name: "MediGarden",
            description: "Manage medications for your entire family",
            start_url: "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2D9F75",
            scope: "/",
            icons: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232D9F75' width='192' height='192'/><text x='50%' y='50%' font-size='100' fill='white' text-anchor='middle' dy='.3em'>üå±</text></svg>",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any"
                },
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%232D9F75' width='512' height='512'/><text x='50%' y='50%' font-size='300' fill='white' text-anchor='middle' dy='.3em'>üå±</text></svg>",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "maskable"
                }
            ],
            categories: ["health", "medical"],
            screenshots: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 540 720'><rect fill='%23f0f0f0' width='540' height='720'/><text x='50%' y='50%' font-size='100' fill='%232D9F75' text-anchor='middle' dy='.3em'>MediGarden</text></svg>",
                    sizes: "540x720",
                    type: "image/svg+xml",
                    form_factor: "narrow"
                }
            ]
        };

        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(blob);
        document.querySelector('link[rel="manifest"]').href = manifestUrl;

        // Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (event) => {
                    event.waitUntil(self.skipWaiting());
                });
                
                self.addEventListener('activate', (event) => {
                    event.waitUntil(self.clients.claim());
                });

                self.addEventListener('push', event => {
                    if (event.data) {
                        const data = event.data.json();
                        self.registration.showNotification(data.title, {
                            body: data.body,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em">üíä</text></svg>',
                            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%232D9F75" width="100" height="100"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em">üíä</text></svg>',
                            tag: data.tag || 'default',
                            requireInteraction: true,
                            actions: [
                                {action: 'taken', title: '‚úì Taken'},
                                {action: 'missed', title: '‚úï Missed'}
                            ]
                        });
                    }
                });
                
                self.addEventListener('notificationclick', event => {
                    event.notification.close();
                    if (event.action === 'taken' || event.action === 'missed') {
                        clients.matchAll().then(windowClients => {
                            for (let i = 0; i < windowClients.length; i++) {
                                const client = windowClients[i];
                                if (client.url.includes('/') && 'focus' in client) {
                                    client.focus();
                                    client.postMessage({
                                        type: 'NOTIFICATION_ACTION',
                                        action: event.action,
                                        medId: event.notification.tag
                                    });
                                    return;
                                }
                            }
                            if (clients.openWindow) {
                                clients.openWindow('/');
                            }
                        });
                    }
                });
            `;
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl).catch(e => console.log('SW Registration failed:', e));
        }
    </script>

    <script>
        window.googleTranslateElementInit = function () {
            if (!window.google || !window.google.translate) return;
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                autoDisplay: false
            }, 'google_translate_element');
        };
    </script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC7UVEDtJb0BF47grWruBwH1H6t0ntOv44",
            authDomain: "familyfirst-af213.firebaseapp.com",
            databaseURL: "https://familyfirst-af213-default-rtdb.firebaseio.com",
            projectId: "familyfirst-af213",
            storageBucket: "familyfirst-af213.firebasestorage.app",
            messagingSenderId: "994214775455",
            appId: "1:994214775455:web:4a76590c830322fbceb0aa"
        };

        firebase.initializeApp(firebaseConfig);

        function app() {
            return {
                isLoggedIn: false,
                currentPage: 'login',
                loginTab: 'signin',
                modal: null,
                meds: [],
                history: {},
                form: {
                    name: '',
                    time: '',
                    dosage: '',
                    notes: '',
                    frequency: { type: 'daily', timesPerDay: 1, duration: 30, durationUnit: 'days' }
                },
                currentMonthOffset: 0,
                uid: null,
                displayName: '',
                userEmail: '',
                profile: { displayName: '', email: '', age: '', region: '', condition: '' },
                inviteUid: '',
                familyMembers: [],
                auth: { email: '', password: '', displayName: '', phone: '', otp: '', phoneVerified: false },
                inAppReminders: [],
                scheduledTimers: {},
                notifPermissionText: 'Unknown',
                familyData: {},
                familyAlerts: [],
                relationshipFilter: 'all',
                relationshipForMember: null,
                viewingMemberGarden: null,
                viewingMemberId: null,
                viewingMemberName: '',
                viewingMemberAdherence: 0,
                viewingMemberStreak: 0,
                viewingMemberStatus: 'Unknown',
                installPrompt: null,
                sidebarOpen: false,
                notificationPanelOpen: false,
                notificationLog: [],
                settings: {
                    soundEnabled: true,
                    medicationReminders: true,
                    familyAlerts: true,
                    language: 'en'
                },
                phrRecords: [],
                phrForm: { type: 'Medical History', title: '', date: '', notes: '', fileName: '', fileData: '' },
                connectedDevices: [],
                remoteMonitoringActive: false,
                remoteMonitorTimer: null,
                recaptchaVerifier: null,
                phoneConfirmationResult: null,
                stepTrackingActive: false,
                heartRateConnected: false,
                bpConnected: false,
                motionWasHigh: false,
                motionLastStepTs: 0,
                motionHandler: null,
                heartRateChar: null,
                bpChar: null,
                vitals: { heartRate: 76, bloodPressure: '120/80', spo2: 98, temperature: 36.8, steps: 1200, lastUpdated: '' },
                vitalsHistory: [],
                aiInsights: [],
                adherenceRiskScore: 0,
                vitalsRiskFlags: 0,
                i18n: {
                    en: {
                        'nav.dashboard': 'Dashboard',
                        'nav.phr': 'PHR',
                        'nav.monitoring': 'Monitoring',
                        'nav.insights': 'AI Insights',
                        'nav.analytics': 'Analytics',
                        'nav.garden': 'Garden',
                        'nav.family': 'Family',
                        'nav.alerts': 'Alerts',
                        'nav.profile': 'Profile',
                        'nav.logout': 'Logout',
                        'phr.title': 'Personal Health Record',
                        'phr.subtitle': 'Store medical history, lab results, allergies, and reference files.',
                        'phr.type': 'Record Type',
                        'phr.medicalHistory': 'Medical History',
                        'phr.labResult': 'Lab Result',
                        'phr.allergy': 'Allergy',
                        'phr.vaccination': 'Vaccination',
                        'phr.date': 'Date',
                        'phr.titleField': 'Title',
                        'phr.notes': 'Notes',
                        'phr.upload': 'Upload Document',
                        'phr.noFile': 'No file selected',
                        'phr.addRecord': 'Add Record',
                        'phr.records': 'Records',
                        'phr.total': 'records',
                        'phr.empty': 'No PHR records yet.',
                        'phr.download': 'Download',
                        'phr.delete': 'Delete',
                        'monitoring.title': 'Remote Monitoring',
                        'monitoring.subtitle': 'Connect wearables and stream real-time vitals.',
                        'monitoring.connectWatch': 'Connect Smart Watch',
                        'monitoring.connectBp': 'Connect BP Device',
                        'monitoring.start': 'Start Real-time Feed',
                        'monitoring.stop': 'Stop Feed',
                        'insights.title': 'AI-Powered Insights',
                        'insights.subtitle': 'Predictive risk and personalized care guidance from adherence and vitals.',
                        'insights.refresh': 'Refresh Insights',
                        'insights.empty': 'No insights yet. Add more data to generate suggestions.',
                        'analytics.title': 'Population Analytics',
                        'analytics.subtitle': 'Adherence patterns by age, region, and condition.',
                        'profile.language': 'Language'
                    },
                    hi: {
                        'nav.dashboard': '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
                        'nav.phr': '‡§™‡•Ä‡§è‡§ö‡§Ü‡§∞',
                        'nav.monitoring': '‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä',
                        'nav.insights': '‡§è‡§Ü‡§à ‡§∏‡•Å‡§ù‡§æ‡§µ',
                        'nav.analytics': '‡§è‡§®‡§æ‡§≤‡§ø‡§ü‡§ø‡§ï‡•ç‡§∏',
                        'nav.garden': '‡§ó‡§æ‡§∞‡•ç‡§°‡§®',
                        'nav.family': '‡§™‡§∞‡§ø‡§µ‡§æ‡§∞',
                        'nav.alerts': '‡§Ö‡§≤‡§∞‡•ç‡§ü',
                        'nav.profile': '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
                        'nav.logout': '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
                        'phr.title': '‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°',
                        'phr.subtitle': '‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä, ‡§≤‡•à‡§¨ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü, ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä ‡§î‡§∞ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§∞‡§ñ‡•á‡§Ç‡•§',
                        'phr.type': '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',
                        'phr.medicalHistory': '‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä',
                        'phr.labResult': '‡§≤‡•à‡§¨ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü',
                        'phr.allergy': '‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä',
                        'phr.vaccination': '‡§ü‡•Ä‡§ï‡§æ‡§ï‡§∞‡§£',
                        'phr.date': '‡§§‡§æ‡§∞‡•Ä‡§ñ',
                        'phr.titleField': '‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï',
                        'phr.notes': '‡§®‡•ã‡§ü‡•ç‡§∏',
                        'phr.upload': '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç',
                        'phr.noFile': '‡§ï‡•ã‡§à ‡§´‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à',
                        'phr.addRecord': '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',
                        'phr.records': '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°',
                        'phr.total': '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°',
                        'phr.empty': '‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§™‡•Ä‡§è‡§ö‡§Ü‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§',
                        'phr.download': '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°',
                        'phr.delete': '‡§π‡§ü‡§æ‡§è‡§Ç',
                        'monitoring.title': '‡§∞‡§ø‡§Æ‡•ã‡§ü ‡§Æ‡•â‡§®‡§ø‡§ü‡§∞‡§ø‡§Ç‡§ó',
                        'monitoring.subtitle': '‡§µ‡•á‡§Ø‡§∞‡•á‡§¨‡§≤ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§µ‡§æ‡§á‡§ü‡§≤‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§',
                        'monitoring.connectWatch': '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§µ‡•â‡§ö ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç',
                        'monitoring.connectBp': '‡§¨‡•Ä‡§™‡•Ä ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç',
                        'monitoring.start': '‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç',
                        'monitoring.stop': '‡§´‡•Ä‡§° ‡§∞‡•ã‡§ï‡•á‡§Ç',
                        'insights.title': '‡§è‡§Ü‡§à-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§∏‡•Å‡§ù‡§æ‡§µ',
                        'insights.subtitle': '‡§è‡§°‡§π‡•á‡§∞‡•á‡§Ç‡§∏ ‡§î‡§∞ ‡§µ‡§æ‡§á‡§ü‡§≤‡•ç‡§∏ ‡§∏‡•á ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§î‡§∞ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§∏‡•Å‡§ù‡§æ‡§µ‡•§',
                        'insights.refresh': '‡§∏‡•Å‡§ù‡§æ‡§µ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç',
                        'insights.empty': '‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§®‡§π‡•Ä‡§Ç‡•§',
                        'analytics.title': '‡§ú‡§®‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§è‡§®‡§æ‡§≤‡§ø‡§ü‡§ø‡§ï‡•ç‡§∏',
                        'analytics.subtitle': '‡§â‡§Æ‡•ç‡§∞, ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§î‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§è‡§°‡§π‡•á‡§∞‡•á‡§Ç‡§∏ ‡§™‡•à‡§ü‡§∞‡•ç‡§®‡•§',
                        'profile.language': '‡§≠‡§æ‡§∑‡§æ'
                    },
                    ta: {
                        'nav.dashboard': '‡Æü‡Ææ‡Æ∑‡Øç‡Æ™‡Øã‡Æ∞‡Øç‡Æü‡ØÅ',
                        'nav.phr': 'PHR',
                        'nav.monitoring': '‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ',
                        'nav.insights': 'AI ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç',
                        'nav.analytics': '‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ',
                        'nav.garden': '‡Æ§‡Øã‡Æü‡Øç‡Æü‡ÆÆ‡Øç',
                        'nav.family': '‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç',
                        'nav.alerts': '‡Æé‡Æö‡Øç‡Æö‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç',
                        'nav.profile': '‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç',
                        'nav.logout': '‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá‡Æ±‡ØÅ',
                        'phr.title': '‡Æ§‡Æ©‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ',
                        'phr.subtitle': '‡ÆÆ‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æµ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ, ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç, ‡ÆÖ‡Æ≤‡Æ∞‡Øç‡Æú‡Æø ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.',
                        'phr.type': '‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æµ‡Æï‡Øà',
                        'phr.medicalHistory': '‡ÆÆ‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æµ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ',
                        'phr.labResult': '‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ',
                        'phr.allergy': '‡ÆÖ‡Æ≤‡Æ∞‡Øç‡Æú‡Æø',
                        'phr.vaccination': '‡Æ§‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡ØÇ‡Æö‡Æø',
                        'phr.date': '‡Æ§‡Øá‡Æ§‡Æø',
                        'phr.titleField': '‡Æ§‡Æ≤‡Øà‡Æ™‡Øç‡Æ™‡ØÅ',
                        'phr.notes': '‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç',
                        'phr.upload': '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡ØÅ',
                        'phr.noFile': '‡Æï‡Øã‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà',
                        'phr.addRecord': '‡Æ™‡Æ§‡Æø‡Æµ‡Øà ‡Æö‡Øá‡Æ∞‡Øç',
                        'phr.records': '‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç',
                        'phr.total': '‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç',
                        'phr.empty': '‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç PHR ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.',
                        'phr.download': '‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡ÆÆ‡Øç',
                        'phr.delete': '‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ',
                        'monitoring.title': '‡Æ§‡Øä‡Æ≤‡Øà‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ',
                        'monitoring.subtitle': '‡Æµ‡Øá‡ÆØ‡Æ∞‡Æ™‡Æø‡Æ≥‡Øç‡Æï‡Æ≥‡Øà ‡Æá‡Æ£‡Øà‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æµ‡Øà‡Æü‡Øç‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øà ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.',
                        'monitoring.connectWatch': '‡Æ∏‡Øç‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æü‡Øç ‡Æµ‡Ææ‡Æü‡Øç‡Æö‡Øç ‡Æá‡Æ£‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                        'monitoring.connectBp': 'BP ‡Æï‡Æ∞‡ØÅ‡Æµ‡Æø ‡Æá‡Æ£‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                        'monitoring.start': '‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ',
                        'monitoring.stop': '‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ',
                        'insights.title': 'AI ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç',
                        'insights.subtitle': '‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ±‡Øç‡Æ±‡Æ≤‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Øà‡Æü‡Øç‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ™‡Ææ‡ÆØ ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ.',
                        'insights.refresh': '‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç',
                        'insights.empty': '‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æ≤‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.',
                        'analytics.title': '‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ',
                        'analytics.subtitle': '‡Æµ‡ÆØ‡Æ§‡ØÅ, ‡Æ™‡Æø‡Æ∞‡Ææ‡Æ®‡Øç‡Æ§‡Æø‡ÆØ‡ÆÆ‡Øç, ‡Æ®‡Æø‡Æ≤‡Øà ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Ææ‡Æ© ‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ±‡Øç‡Æ±‡Æ≤‡Øç.',
                        'profile.language': '‡ÆÆ‡Øä‡Æ¥‡Æø'
                    }
                },

                get calendarDays() {
                    const d = new Date();
                    d.setMonth(d.getMonth() + this.currentMonthOffset, 1);
                    const month = d.getMonth();
                    const firstWeekday = new Date(d.getFullYear(), month, 1).getDay();
                    const daysInMonth = new Date(d.getFullYear(), month + 1, 0).getDate();
                    const arr = [];
                    for (let i = 0; i < firstWeekday; i++) arr.push({ day: '', markerClass: '', markerText: '' });
                    for (let day = 1; day <= daysInMonth; day++) {
                        const key = `${d.getFullYear()}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const rec = this.history[key];
                        let cl = 'bg-gray-100', text = '';
                        if (rec) {
                            if (rec.taken === rec.total) { cl = 'bg-green-500 text-white'; text = '‚úì'; }
                            else if ((rec.taken || 0) > 0) { cl = 'bg-yellow-500 text-white'; text = '-'; }
                            else { cl = 'bg-red-500 text-white'; text = '‚úï'; }
                        }
                        arr.push({ day, markerClass: cl + ' p-3 rounded text-center', markerText: text });
                    }
                    return arr;
                },

                init() {
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.installPrompt = e;
                    });

                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.controller?.postMessage({ type: 'INIT' });
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data.type === 'NOTIFICATION_ACTION') {
                                if (event.data.action === 'taken') {
                                    this.takeMedicationById(event.data.medId);
                                } else if (event.data.action === 'missed') {
                                    this.markMedicationMissed(event.data.medId);
                                }
                            }
                        });
                    }

                    firebase.auth().onAuthStateChanged(async (user) => {
                        if (user) {
                            this.isLoggedIn = true;
                            this.uid = user.uid;
                            this.displayName = user.displayName || 'User';
                            this.userEmail = user.email || 'guest@medigarden.com';
                            this.profile.email = user.email || '';
                            this.profile.displayName = user.displayName || '';
                            this.currentPage = 'dashboard';
                            await this.loadFromFirebase();
                            this.scheduleAllNotifications();
                            this.checkFamilyAlerts();
                            this.runAiInsights();
                            setInterval(() => this.checkFamilyAlerts(), 3600 * 1000);
                        } else {
                            this.isLoggedIn = false;
                            this.currentPage = 'login';
                        }
                    });

                    setInterval(() => this.checkDueReminders(), 60 * 1000);
                    this.updateNotifPermissionText();
                    this.loadSettings();
                    document.cookie = 'googtrans=/en/en; path=/';
                    this.$watch('settings.language', () => {
                        this.saveSettings();
                        this.translateWholeApp();
                    });
                },

                installApp() {
                    if (this.installPrompt) {
                        this.installPrompt.prompt();
                        this.installPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                this.installPrompt = null;
                                alert('üéâ App installed successfully! You can now access it from your home screen.');
                            }
                        });
                    }
                },

                loadSettings() {
                    const saved = localStorage.getItem('medigarden_settings');
                    if (saved) this.settings = { ...this.settings, ...JSON.parse(saved) };
                    this.settings.language = 'en';
                },

                goTo(page) {
                    this.currentPage = page;
                    if (window.innerWidth < 1024) this.sidebarOpen = false;
                },

                pushNotification(title, message, level = 'info') {
                    this.notificationLog.unshift({
                        id: this.cryptoId(),
                        title,
                        message,
                        level,
                        read: false,
                        ts: Date.now()
                    });
                    if (this.notificationLog.length > 80) this.notificationLog.pop();
                },

                markAllNotificationsRead() {
                    this.notificationLog = this.notificationLog.map(n => ({ ...n, read: true }));
                },

                translateWholeApp() {
                    const target = this.settings.language || 'en';
                    const cookieVal = target === 'en' ? '/en/en' : `/en/${target}`;
                    document.cookie = `googtrans=${cookieVal}; path=/`;

                    if (target === 'en') return;

                    const applyChange = () => {
                        const combo = document.querySelector('.goog-te-combo');
                        if (!combo) return;
                        combo.value = target;
                        combo.dispatchEvent(new Event('change'));
                    };

                    if (window.google && window.google.translate) {
                        setTimeout(applyChange, 180);
                        return;
                    }

                    if (!document.getElementById('google-translate-script')) {
                        const s = document.createElement('script');
                        s.id = 'google-translate-script';
                        s.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
                        document.body.appendChild(s);
                    }

                    setTimeout(applyChange, 900);
                },

                initRecaptcha() {
                    if (this.recaptchaVerifier) return this.recaptchaVerifier;
                    this.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        size: 'invisible'
                    });
                    return this.recaptchaVerifier;
                },

                async sendPhoneOtp() {
                    if (!this.auth.phone) {
                        alert('Enter phone number in international format (e.g. +91XXXXXXXXXX).');
                        return;
                    }
                    try {
                        const appVerifier = this.initRecaptcha();
                        this.phoneConfirmationResult = await firebase.auth().signInWithPhoneNumber(this.auth.phone, appVerifier);
                        alert('OTP sent to your phone.');
                    } catch (e) {
                        alert('Phone OTP send failed: ' + e.message);
                    }
                },

                async verifyPhoneOtp() {
                    if (!this.phoneConfirmationResult || !this.auth.otp) {
                        alert('Send OTP first, then enter the code.');
                        return;
                    }
                    try {
                        await this.phoneConfirmationResult.confirm(this.auth.otp);
                        this.auth.phoneVerified = true;
                        await firebase.auth().signOut();
                        alert('Phone verified successfully.');
                    } catch (e) {
                        alert('OTP verification failed: ' + e.message);
                    }
                },

                saveSettings() {
                    localStorage.setItem('medigarden_settings', JSON.stringify(this.settings));
                },

                async signUp() {
                    try {
                        if (this.auth.phone && !this.auth.phoneVerified) {
                            alert('Verify phone with OTP or leave phone blank.');
                            return;
                        }
                        const res = await firebase.auth().createUserWithEmailAndPassword(this.auth.email, this.auth.password);
                        await res.user.updateProfile({ displayName: this.auth.displayName });
                        await res.user.sendEmailVerification();
                        await firebase.database().ref(`users/${res.user.uid}/profile`).set({
                            displayName: this.auth.displayName,
                            email: this.auth.email,
                            phone: this.auth.phone || '',
                            phoneVerified: !!this.auth.phoneVerified,
                            createdAt: new Date().toISOString()
                        });
                        await firebase.auth().signOut();
                        this.auth = { email: '', password: '', displayName: '', phone: '', otp: '', phoneVerified: false };
                        alert('Account created. Verification link sent to your email. Verify email, then sign in.');
                    } catch (e) {
                        alert('Sign up error: ' + e.message);
                    }
                },

                async signIn() {
                    try {
                        const cred = await firebase.auth().signInWithEmailAndPassword(this.auth.email, this.auth.password);
                        if (cred.user && !cred.user.emailVerified) {
                            await cred.user.sendEmailVerification();
                            await firebase.auth().signOut();
                            alert('Email not verified. We sent a new verification link.');
                            return;
                        }
                        this.auth.password = '';
                    } catch (e) {
                        alert('Sign in error: ' + e.message);
                    }
                },

                async signInWithGoogle() {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        const res = await firebase.auth().signInWithPopup(provider);
                        const p = { displayName: res.user.displayName || '', email: res.user.email || '' };
                        await firebase.database().ref(`users/${res.user.uid}/profile`).set(p);
                    } catch (e) {
                        alert('Google sign-in error: ' + e.message);
                    }
                },

                async logout() {
                    try {
                        if (this.remoteMonitorTimer) {
                            clearInterval(this.remoteMonitorTimer);
                            this.remoteMonitorTimer = null;
                        }
                        if (this.motionHandler) {
                            window.removeEventListener('devicemotion', this.motionHandler);
                            this.motionHandler = null;
                        }
                        this.stepTrackingActive = false;
                        this.remoteMonitoringActive = false;
                        await firebase.auth().signOut();
                        this.isLoggedIn = false;
                        this.currentPage = 'login';
                    } catch (e) {
                        alert('Logout error');
                    }
                },

                async loadFromFirebase() {
                    if (!this.uid) return;
                    const ref = firebase.database().ref(`users/${this.uid}`);
                    ref.on('value', async (snap) => {
                        const val = snap.val() || {};
                        if (val.state) {
                            this.meds = (val.state.meds || []).map(m => ({ ...m, id: m.id || this.cryptoId() }));
                            this.history = val.state.history || {};
                            this.phrRecords = val.state.phrRecords || [];
                            this.vitals = val.state.vitals || this.vitals;
                            this.vitalsHistory = val.state.vitalsHistory || [];
                        }
                        this.profile = { ...this.profile, ...(val.profile || {}) };
                        this.displayName = this.profile.displayName || this.displayName;
                        await this.loadFamilyList(val.family || {});
                        this.loadFamilyData();
                        this.runAiInsights();
                    });
                },

                async loadFamilyList(familyObj) {
                    const newMembers = [];
                    const familyKeys = Object.keys(familyObj || {});

                    console.log('Loading family members, count:', familyKeys.length);

                    for (const fid of familyKeys) {
                        try {
                            const snap = await firebase.database().ref(`users/${fid}/profile`).once('value');
                            const p = snap.val() || {};
                            const member = {
                                uid: fid,
                                displayName: p.displayName || 'Unknown',
                                email: p.email || 'N/A',
                                relationship: p.relationship || 'Family Member'
                            };
                            newMembers.push(member);
                            console.log('Added member:', member);
                        } catch (e) {
                            console.error('Error loading member ' + fid + ':', e);
                            newMembers.push({ uid: fid, displayName: 'Error Loading', email: '' });
                        }
                    }

                    // Directly assign to trigger Alpine reactivity
                    this.familyMembers = [...newMembers];
                    console.log('Family members updated:', this.familyMembers);
                },

                async loadFamilyData() {
                    if (this.familyMembers.length === 0) {
                        console.log('No family members to load data for');
                        this.familyData = {};
                        return;
                    }

                    console.log('Loading data for', this.familyMembers.length, 'members');

                    const newFamilyData = {};
                    for (const member of this.familyMembers) {
                        try {
                            const snap = await firebase.database().ref(`users/${member.uid}/state`).once('value');
                            const data = snap.val() || { history: {}, meds: [] };
                            newFamilyData[member.uid] = data;
                            console.log('Loaded data for ' + member.displayName + ' (UID: ' + member.uid + '):', JSON.stringify(data).substring(0, 100) + '...');
                        } catch (e) {
                            console.log('Could not load family data for ' + member.uid + ':', e.message);
                            newFamilyData[member.uid] = { history: {}, meds: [] };
                        }
                    }

                    // Complete reassignment to ensure Alpine reactivity
                    this.familyData = newFamilyData;
                    console.log('Family data assignment complete. Total members:', Object.keys(this.familyData).length);

                    // Force Alpine reactivity update
                    this.$watch('familyData', (newVal) => {
                        console.log('familyData changed:', newVal);
                    });
                },

                async checkFamilyAlerts() {
                    if (!this.settings.familyAlerts) return;

                    this.familyAlerts = [];
                    for (const member of this.familyMembers) {
                        const data = this.familyData[member.uid] || {};
                        const history = data.history || {};
                        let missedDays = 0;

                        for (let i = 0; i < 2; i++) {
                            const k = this.getTodayKey(-i);
                            const rec = history[k];
                            if (!rec || (rec.taken || 0) === 0) missedDays++;
                        }

                        if (missedDays >= 2) {
                            const alert = {
                                id: member.uid + '-' + Date.now(),
                                memberId: member.uid,
                                memberName: member.displayName || member.email,
                                message: `${member.displayName || 'This member'} has missed medications for ${missedDays} consecutive days!`,
                                severity: missedDays > 2 ? 'critical' : 'warning',
                                timestamp: new Date().toISOString()
                            };

                            this.familyAlerts.push(alert);
                            this.pushNotification('Family Alert', alert.message, alert.severity);
                            await this.sendFamilyNotification(alert);
                        }
                    }
                },

                async sendFamilyNotification(alert) {
                    if (Notification.permission === 'granted' && this.settings.familyAlerts) {
                        const notification = new Notification(`‚ö†Ô∏è ${alert.memberName}`, {
                            body: alert.message,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em">üë•</text></svg>',
                            tag: alert.id,
                            requireInteraction: true
                        });

                        if (this.settings.soundEnabled) {
                            this.playNotificationSound();
                        }
                    }
                },

                getTodayKey(offset = 0) {
                    const d = new Date();
                    d.setDate(d.getDate() + offset);
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                },

                getTodaysMeds() {
                    return this.meds.filter(m => {
                        const freq = m.frequency || { type: 'daily' };
                        if (freq.type === 'daily') return true;
                        return true;
                    });
                },

                getFrequencyLabel(freq) {
                    if (!freq) return 'Daily';
                    if (freq.type === 'daily') return 'Daily';
                    if (freq.type === 'custom') {
                        return `${freq.timesPerDay}x/day for ${freq.duration} ${freq.durationUnit}`;
                    }
                    return 'Daily';
                },

                t(key) {
                    const lang = this.settings.language || 'en';
                    return (this.i18n[lang] && this.i18n[lang][key]) || this.i18n.en[key] || key.split('.').pop();
                },

                onPhrFileChange(event) {
                    const file = event?.target?.files?.[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        this.phrForm.fileName = file.name;
                        this.phrForm.fileData = reader.result || '';
                    };
                    reader.readAsDataURL(file);
                },

                addPhrRecord() {
                    if (!this.phrForm.title) {
                        alert('Please enter a title for this record.');
                        return;
                    }
                    this.phrRecords.unshift({
                        id: this.cryptoId(),
                        ...this.phrForm,
                        createdAt: new Date().toISOString()
                    });
                    this.phrForm = { type: 'Medical History', title: '', date: '', notes: '', fileName: '', fileData: '' };
                    this.save();
                },

                deletePhrRecord(id) {
                    this.phrRecords = this.phrRecords.filter(r => r.id !== id);
                    this.save();
                },

                downloadPhrRecord(id) {
                    const rec = this.phrRecords.find(r => r.id === id);
                    if (!rec) return;
                    if (rec.fileData) {
                        const a = document.createElement('a');
                        a.href = rec.fileData;
                        a.download = rec.fileName || `${rec.title || 'record'}.txt`;
                        a.click();
                        return;
                    }
                    const data = `Type: ${rec.type}\nTitle: ${rec.title}\nDate: ${rec.date}\nNotes: ${rec.notes}`;
                    const blob = new Blob([data], { type: 'text/plain' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${rec.title || 'record'}.txt`;
                    a.click();
                },

                parseSfloat16(raw) {
                    let mantissa = raw & 0x0fff;
                    let exponent = raw >> 12;
                    if (mantissa >= 0x0800) mantissa = -(0x1000 - mantissa);
                    if (exponent >= 0x0008) exponent = -(0x0010 - exponent);
                    return mantissa * Math.pow(10, exponent);
                },

                async togglePedometerTracking() {
                    if (this.stepTrackingActive) {
                        if (this.motionHandler) window.removeEventListener('devicemotion', this.motionHandler);
                        this.stepTrackingActive = false;
                        return;
                    }

                    if (typeof DeviceMotionEvent === 'undefined') {
                        alert('Device motion API not available on this device/browser.');
                        return;
                    }

                    try {
                        if (typeof DeviceMotionEvent.requestPermission === 'function') {
                            const p = await DeviceMotionEvent.requestPermission();
                            if (p !== 'granted') {
                                alert('Motion permission denied.');
                                return;
                            }
                        }
                        this.motionHandler = (event) => {
                            const acc = event.accelerationIncludingGravity || event.acceleration;
                            if (!acc) return;
                            const x = acc.x || 0, y = acc.y || 0, z = acc.z || 0;
                            const mag = Math.sqrt(x * x + y * y + z * z);
                            const now = Date.now();
                            const high = mag > 12.2;
                            const low = mag < 10.3;

                            if (high && !this.motionWasHigh && (now - this.motionLastStepTs) > 300) {
                                this.motionWasHigh = true;
                            } else if (this.motionWasHigh && low) {
                                this.motionWasHigh = false;
                                this.motionLastStepTs = now;
                                this.vitals.steps += 1;
                                this.vitals.lastUpdated = new Date().toISOString();
                                if (this.vitals.steps % 10 === 0) this.save();
                            }
                        };

                        window.addEventListener('devicemotion', this.motionHandler, { passive: true });
                        this.stepTrackingActive = true;
                    } catch (e) {
                        alert('Unable to start pedometer: ' + e.message);
                    }
                },

                async connectHeartRateMonitor() {
                    if (!navigator.bluetooth) {
                        alert('Bluetooth not supported in this browser.');
                        return;
                    }
                    try {
                        const device = await navigator.bluetooth.requestDevice({
                            filters: [{ services: ['heart_rate'] }]
                        });
                        const server = await device.gatt.connect();
                        const service = await server.getPrimaryService('heart_rate');
                        const characteristic = await service.getCharacteristic('heart_rate_measurement');
                        await characteristic.startNotifications();
                        characteristic.addEventListener('characteristicvaluechanged', (event) => {
                            const value = event.target.value;
                            const flags = value.getUint8(0);
                            const hr = (flags & 0x1) ? value.getUint16(1, true) : value.getUint8(1);
                            this.vitals.heartRate = hr;
                            this.vitals.lastUpdated = new Date().toISOString();
                            this.heartRateConnected = true;
                            this.save();
                        });
                        this.heartRateChar = characteristic;
                        this.heartRateConnected = true;
                    } catch (e) {
                        alert('Heart rate device connection failed: ' + e.message);
                    }
                },

                async connectBpMonitor() {
                    if (!navigator.bluetooth) {
                        alert('Bluetooth not supported in this browser.');
                        return;
                    }
                    try {
                        const device = await navigator.bluetooth.requestDevice({
                            filters: [{ services: ['blood_pressure'] }]
                        });
                        const server = await device.gatt.connect();
                        const service = await server.getPrimaryService('blood_pressure');
                        const characteristic = await service.getCharacteristic('blood_pressure_measurement');
                        await characteristic.startNotifications();
                        characteristic.addEventListener('characteristicvaluechanged', (event) => {
                            const value = event.target.value;
                            let idx = 1;
                            const sys = this.parseSfloat16(value.getUint16(idx, true)); idx += 2;
                            const dia = this.parseSfloat16(value.getUint16(idx, true));
                            this.vitals.bloodPressure = `${Math.round(sys)}/${Math.round(dia)}`;
                            this.vitals.lastUpdated = new Date().toISOString();
                            this.bpConnected = true;
                            this.save();
                        });
                        this.bpChar = characteristic;
                        this.bpConnected = true;
                    } catch (e) {
                        alert('BP monitor connection failed: ' + e.message);
                    }
                },

                toggleRemoteMonitoring() {
                    if (this.remoteMonitoringActive) {
                        this.remoteMonitoringActive = false;
                        if (this.remoteMonitorTimer) clearInterval(this.remoteMonitorTimer);
                        this.remoteMonitorTimer = null;
                        return;
                    }
                    this.remoteMonitoringActive = true;
                    this.simulateVitalUpdate();
                    this.remoteMonitorTimer = setInterval(() => this.simulateVitalUpdate(), 10000);
                },

                simulateVitalUpdate() {
                    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                    const sys = rand(108, 145);
                    const dia = rand(68, 95);
                    this.vitals = {
                        heartRate: this.heartRateConnected ? this.vitals.heartRate : rand(58, 112),
                        bloodPressure: this.bpConnected ? this.vitals.bloodPressure : `${sys}/${dia}`,
                        spo2: rand(92, 100),
                        temperature: (Math.round((36 + Math.random() * 2) * 10) / 10),
                        steps: this.stepTrackingActive ? this.vitals.steps : this.vitals.steps + rand(30, 220),
                        lastUpdated: new Date().toISOString()
                    };
                    this.vitalsHistory.push({ ...this.vitals });
                    if (this.vitalsHistory.length > 120) this.vitalsHistory.shift();
                    this.runAiInsights();
                    this.save();
                },

                runAiInsights() {
                    const insights = [];
                    const missedRate = 100 - this.weekAdherence;
                    this.vitalsRiskFlags = 0;
                    if (this.vitals.heartRate > 100 || this.vitals.heartRate < 60) this.vitalsRiskFlags++;
                    if (this.vitals.spo2 < 94) this.vitalsRiskFlags++;
                    if (this.vitals.temperature >= 37.8) this.vitalsRiskFlags++;
                    const bpParts = (this.vitals.bloodPressure || '120/80').split('/');
                    const bpS = parseInt(bpParts[0] || '120', 10);
                    const bpD = parseInt(bpParts[1] || '80', 10);
                    if (bpS >= 140 || bpD >= 90) this.vitalsRiskFlags++;

                    this.adherenceRiskScore = Math.min(100, Math.max(0, Math.round(missedRate * 0.7 + this.vitalsRiskFlags * 12)));

                    if (this.adherenceRiskScore >= 70) {
                        insights.push({
                            id: 'high-risk',
                            level: 'high',
                            title: 'High adherence risk detected',
                            message: 'Missed-dose trend is elevated. Add family check-ins and simplify your medication routine.'
                        });
                    } else if (this.adherenceRiskScore >= 40) {
                        insights.push({
                            id: 'medium-risk',
                            level: 'medium',
                            title: 'Moderate adherence risk',
                            message: 'Consider adding reminder windows and linking doses to fixed daily habits.'
                        });
                    } else {
                        insights.push({
                            id: 'low-risk',
                            level: 'low',
                            title: 'Adherence risk is low',
                            message: 'Current medication behavior looks stable. Keep the same schedule.'
                        });
                    }

                    if (this.vitalsRiskFlags > 0) {
                        insights.push({
                            id: 'vitals',
                            level: this.vitalsRiskFlags >= 2 ? 'high' : 'medium',
                            title: 'Vitals need attention',
                            message: `Detected ${this.vitalsRiskFlags} vitals flags. Recheck device readings and consult your clinician if this persists.`
                        });
                    }

                    if (this.todayTaken < this.todayTotal && this.todayTotal > 0) {
                        insights.push({
                            id: 'today-plan',
                            level: 'medium',
                            title: 'Today plan suggestion',
                            message: `You still have ${this.todayTotal - this.todayTaken} dose(s) pending. Enable tighter reminder windows for today.`
                        });
                    }

                    this.aiInsights = insights;
                },

                saveLocal() {
                    localStorage.setItem('medigarden_state', JSON.stringify({ meds: this.meds, history: this.history }));
                },

                save() {
                    this.saveLocal();
                    if (this.uid) {
                        firebase.database().ref(`users/${this.uid}/state`).set({
                            meds: this.meds,
                            history: this.history,
                            phrRecords: this.phrRecords,
                            vitals: this.vitals,
                            vitalsHistory: this.vitalsHistory,
                            updatedAt: new Date().toISOString()
                        }).catch(e => console.error('Save error:', e));
                    }
                    this.scheduleAllNotifications();
                },

                scheduleAllNotifications() {
                    Object.values(this.scheduledTimers).forEach(t => clearTimeout(t));
                    this.scheduledTimers = {};
                    for (const med of this.meds) this.scheduleNotificationForMed(med);
                },

                scheduleNotificationForMed(med) {
                    if (!med || !med.time) return;
                    const [hh, mm] = med.time.split(':').map(n => parseInt(n));
                    const now = new Date();
                    let next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm);
                    if (next <= now) next = new Date(next.getTime() + 24 * 3600 * 1000);
                    const ms = next.getTime() - now.getTime();
                    this.scheduledTimers[med.id] = setTimeout(() => {
                        this.triggerReminder(med);
                        if (med.frequency?.type === 'daily') this.scheduleNotificationForMed(med);
                    }, ms);
                },

                checkDueReminders() {
                    if (!this.settings.medicationReminders) return;

                    const now = new Date();
                    for (const med of this.getTodaysMeds()) {
                        if (med.taken) continue;
                        const [hh, mm] = (med.time || '00:00').split(':').map(n => parseInt(n));
                        const scheduled = new Date();
                        scheduled.setHours(hh, mm);
                        if (Math.abs(scheduled - now) < 61000 && !this.inAppReminders.find(r => r.medId === med.id)) {
                            this.triggerReminder(med);
                        }
                    }
                },

                triggerReminder(med) {
                    this.inAppReminders.push({ medId: med.id, name: med.name, time: med.time });
                    this.pushNotification('Medication Reminder', `${med.name} is due at ${med.time}.`, 'warning');
                    if (Notification.permission === 'granted') {
                        const notification = new Notification('üíä Medication Time!', {
                            body: `${med.name} at ${med.time}`,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em">üíä</text></svg>',
                            tag: med.id,
                            requireInteraction: true,
                            actions: [
                                { action: 'taken', title: '‚úì Taken' },
                                { action: 'missed', title: '‚úï Missed' }
                            ]
                        });

                        notification.onclick = () => {
                            window.focus();
                            this.takeMedicationById(med.id);
                        };
                    }

                    if (this.settings.soundEnabled) {
                        this.playNotificationSound();
                    }
                },

                playNotificationSound() {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Sound notification failed:', e);
                    }
                },

                handleReminderYes(r) {
                    this.takeMedicationById(r.medId);
                    this.inAppReminders = this.inAppReminders.filter(x => x.medId !== r.medId);
                },

                handleReminderMissed(r) {
                    this.markMedicationMissed(r.medId);
                    this.inAppReminders = this.inAppReminders.filter(x => x.medId !== r.medId);
                },

                snoozeReminder(r, min) {
                    this.inAppReminders = this.inAppReminders.filter(x => x.medId !== r.medId);
                    setTimeout(() => this.triggerReminder(this.meds.find(m => m.id === r.medId)), min * 60 * 1000);
                },

                takeMedicationById(id) {
                    const med = this.meds.find(m => m.id === id);
                    if (!med || med.taken) return;
                    med.taken = true;
                    const key = this.getTodayKey();
                    const rec = this.history[key] || { total: this.getTodaysMeds().length, taken: 0 };
                    rec.taken = (rec.taken || 0) + 1;
                    rec.total = this.getTodaysMeds().length;
                    rec.lastTakenAt = new Date().toISOString();
                    this.history[key] = rec;
                    this.save();
                    this.runAiInsights();
                    this.checkFamilyAlerts();
                },

                markMedicationMissed(id) {
                    const med = this.meds.find(m => m.id === id);
                    if (!med) return;
                    const key = this.getTodayKey();
                    const rec = this.history[key] || { total: this.getTodaysMeds().length, taken: 0 };
                    rec.total = this.getTodaysMeds().length;
                    rec.missedAt = new Date().toISOString();
                    this.history[key] = rec;
                    this.save();
                    this.runAiInsights();
                },

                openAdd() {
                    this.form = {
                        name: '',
                        time: '',
                        dosage: '',
                        notes: '',
                        frequency: { type: 'daily', timesPerDay: 1, duration: 30, durationUnit: 'days' }
                    };
                    this.modal = 'add';
                },

                openEditMed(med) {
                    this.form = { ...med };
                    if (!this.form.frequency) {
                        this.form.frequency = { type: 'daily', timesPerDay: 1, duration: 30, durationUnit: 'days' };
                    }
                    this.modal = 'edit';
                },

                submitAdd() {
                    if (!this.form.name || !this.form.time) return;
                    if (this.modal === 'edit') {
                        const idx = this.meds.findIndex(m => m.id === this.form.id);
                        if (idx >= 0) this.meds[idx] = { ...this.form };
                    } else {
                        this.meds.push({ id: this.cryptoId(), ...this.form });
                    }
                    this.save();
                    this.modal = null;
                },

                deleteMedication(id) {
                    if (confirm('Delete this medication?')) {
                        this.meds = this.meds.filter(m => m.id !== id);
                        this.save();
                    }
                },

                copyShareCode() {
                    navigator.clipboard?.writeText(this.uid).then(() => alert('Share code copied to clipboard!'));
                },

                async addFamilyMember() {
                    if (!this.uid || !this.inviteUid) { alert('Please enter a valid code'); return; }
                    if (this.inviteUid === this.uid) { alert('You cannot add yourself'); return; }
                    try {
                        console.log('Adding family member with UID:', this.inviteUid);

                        // First verify the code exists
                        const snap = await firebase.database().ref(`users/${this.inviteUid}/profile`).once('value');
                        if (!snap.exists()) {
                            console.log('Invalid code - user not found');
                            alert('Invalid code - user not found');
                            return;
                        }

                        console.log('Code validated, user found:', snap.val());

                        // Add bidirectional connection
                        const updates = {};
                        updates[`users/${this.uid}/family/${this.inviteUid}`] = true;
                        updates[`users/${this.inviteUid}/family/${this.uid}`] = true;

                        await firebase.database().ref().update(updates);
                        console.log('Family connection created in Firebase');

                        this.inviteUid = '';

                        // Reload family list and data with a delay to ensure Firebase sync
                        console.log('Waiting for Firebase sync before reloading...');
                        await new Promise(resolve => setTimeout(resolve, 1500));

                        console.log('Reading family data from Firebase...');
                        const familySnap = await firebase.database().ref(`users/${this.uid}/family`).once('value');
                        const familyObj = familySnap.val() || {};
                        console.log('Family object from Firebase:', familyObj);
                        console.log('Family member count:', Object.keys(familyObj).length);

                        await this.loadFamilyList(familyObj);
                        console.log('After loadFamilyList - familyMembers:', this.familyMembers);

                        await this.loadFamilyData();
                        console.log('After loadFamilyData - familyData:', this.familyData);

                        alert('Family member added successfully! Refreshing...');
                    } catch (e) {
                        console.log('Error adding family member:', e);
                        alert('Error adding family member: ' + e.message);
                    }
                },

                async removeFamilyMember(fid) {
                    if (!confirm('Remove this family member?')) return;
                    const updates = {};
                    updates[`users/${this.uid}/family/${fid}`] = null;
                    updates[`users/${fid}/family/${this.uid}`] = null;
                    await firebase.database().ref().update(updates);
                    this.familyMembers = this.familyMembers.filter(m => m.uid !== fid);
                },

                openSetRelationship(uid) {
                    this.relationshipForMember = uid;
                    this.modal = 'setRelationship';
                },

                async setMemberRelationship(rel) {
                    const member = this.familyMembers.find(m => m.uid === this.relationshipForMember);
                    if (member) {
                        member.relationship = rel;
                        await firebase.database().ref(`users/${this.relationshipForMember}/profile/relationship`).set(rel);
                    }
                },

                async viewMemberGarden(uid) {
                    const member = this.familyMembers.find(m => m.uid === uid);
                    if (!member) {
                        alert('Member not found');
                        return;
                    }

                    // Ensure data is loaded for this member
                    if (!this.familyData[uid]) {
                        try {
                            const snap = await firebase.database().ref(`users/${uid}/state`).once('value');
                            this.familyData[uid] = snap.val() || { history: {}, meds: [] };
                        } catch (e) {
                            console.error('Error loading member data:', e);
                            this.familyData[uid] = { history: {}, meds: [] };
                        }
                    }

                    this.viewingMemberId = uid;
                    this.viewingMemberName = member.displayName || member.email || uid;
                    this.viewingMemberAdherence = this.getMemberAdherence(uid);
                    this.viewingMemberStreak = this.getMemberStreak(uid);
                    this.viewingMemberStatus = this.getMemberStatus(uid);
                    this.viewingMemberGarden = true;
                },

                getMemberEmoji(uid) {
                    const status = this.getMemberStatus(uid);
                    return status === 'On Track' ? 'üòä' : 'üòü';
                },

                getMemberAdherence(uid) {
                    const data = this.familyData[uid] || {};
                    const hist = data.history || {};
                    const scores = [];

                    console.log('getMemberAdherence for', uid, '- data exists:', !!this.familyData[uid], 'history keys:', Object.keys(hist).length);

                    for (let i = 0; i < 7; i++) {
                        const k = this.getTodayKey(-i);
                        const r = hist[k];
                        if (r && r.total > 0) {
                            scores.push((r.taken || 0) / r.total * 100);
                        }
                    }

                    const result = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
                    console.log('getMemberAdherence for', uid, '- result:', result);
                    return result;
                },

                getMemberStreak(uid) {
                    const data = this.familyData[uid] || {};
                    const hist = data.history || {};
                    let s = 0;
                    for (let i = 0; i < 30; i++) {
                        const k = this.getTodayKey(-i);
                        const r = hist[k];
                        if (r && r.total > 0 && r.taken === r.total) s++;
                        else break;
                    }
                    return s;
                },

                getMemberStatus(uid) {
                    return this.getMemberAdherence(uid) >= 70 ? 'On Track' : 'Needs Help';
                },

                markAlertResolved(id) {
                    this.familyAlerts = this.familyAlerts.filter(a => a.id !== id);
                },

                async sendEncouragementMessage(uid) {
                    const member = this.familyMembers.find(m => m.uid === uid);
                    if (member) {
                        const msg = `Keep going! üí™ We're here to support you. You can do this! üåü`;
                        alert(`Message sent to ${member.displayName}: "${msg}"`);
                    }
                },

                updateNotifPermissionText() {
                    this.notifPermissionText = Notification.permission;
                },

                async requestNotificationPermission() {
                    const p = await Notification.requestPermission();
                    this.updateNotifPermissionText();
                    if (p === 'granted') {
                        this.pushNotification('Notifications Enabled', 'You will now receive reminders and family alerts.', 'success');
                        alert('‚úÖ Notifications enabled! You will now receive reminders even when the app is closed.');
                    }
                },

                async updateProfile() {
                    this.saveSettings();
                    if (this.uid) {
                        await firebase.database().ref(`users/${this.uid}/profile`).update(this.profile).catch(e => console.error(e));
                    }
                    alert('‚úÖ Settings saved successfully!');
                },

                offsetMonth(d) {
                    this.currentMonthOffset += d;
                },

                getPopulationDataset() {
                    const classifyAge = (age) => {
                        const n = parseInt(age || '0', 10);
                        if (!n) return 'Unknown';
                        if (n < 18) return '<18';
                        if (n < 35) return '18-34';
                        if (n < 50) return '35-49';
                        if (n < 65) return '50-64';
                        return '65+';
                    };
                    const list = [];
                    list.push({
                        ageGroup: classifyAge(this.profile.age),
                        region: this.profile.region || 'Unknown',
                        condition: this.profile.condition || 'General',
                        adherence: this.weekAdherence
                    });
                    for (const member of this.familyMembers) {
                        const adh = this.getMemberAdherence(member.uid);
                        list.push({
                            ageGroup: 'Unknown',
                            region: 'Unknown',
                            condition: 'General',
                            adherence: adh
                        });
                    }
                    return list;
                },

                aggregatePopulation(field) {
                    const data = this.getPopulationDataset();
                    const groups = {};
                    for (const row of data) {
                        const key = row[field] || 'Unknown';
                        if (!groups[key]) groups[key] = { sum: 0, count: 0 };
                        groups[key].sum += row.adherence || 0;
                        groups[key].count += 1;
                    }
                    return Object.keys(groups).map(k => ({
                        label: k,
                        value: Math.round(groups[k].sum / (groups[k].count || 1))
                    })).sort((a, b) => b.value - a.value);
                },

                get analyticsByAge() {
                    return this.aggregatePopulation('ageGroup');
                },

                get analyticsByRegion() {
                    return this.aggregatePopulation('region');
                },

                get analyticsByCondition() {
                    return this.aggregatePopulation('condition');
                },

                get filteredFamilyMembers() {
                    if (this.relationshipFilter === 'all') return this.familyMembers;
                    return this.familyMembers.filter(m => (m.relationship || '').toLowerCase() === this.relationshipFilter);
                },

                get populationMetrics() {
                    const data = this.getPopulationDataset();
                    const avg = data.reduce((s, d) => s + (d.adherence || 0), 0) / (data.length || 1);
                    return {
                        total: data.length,
                        avgAdherence: Math.round(avg),
                        highRiskCount: data.filter(d => (d.adherence || 0) < 60).length
                    };
                },

                get currentMonthLabel() {
                    const d = new Date();
                    d.setMonth(d.getMonth() + this.currentMonthOffset);
                    return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
                },

                get todayTotal() { return this.getTodaysMeds().length; },
                get todayTaken() { return this.getTodaysMeds().filter(m => m.taken).length; },
                get totalDoses() { return Object.values(this.history).reduce((s, r) => s + (r.taken || 0), 0); },
                get todayLabel() { return new Date().toLocaleString(undefined, { weekday: 'long', month: 'short', day: 'numeric' }); },
                get todayStatus() {
                    const t = this.todayTaken, tot = this.todayTotal;
                    return t === 0 ? 'Future' : (t === tot && tot > 0 ? 'All Taken' : 'Partial');
                },
                get healthScore() {
                    const scores = [];
                    for (let i = 0; i < 7; i++) {
                        const r = this.history[this.getTodayKey(-i)];
                        if (r && r.total > 0) scores.push((r.taken || 0) / r.total * 100);
                    }
                    return scores.reduce((a, b) => a + b, 0) / (scores.length || 1);
                },
                get weekAdherence() { return Math.round(this.healthScore); },
                get unreadNotifications() { return this.notificationLog.filter(n => !n.read).length; },
                get streak() {
                    let s = 0;
                    for (let i = 0; i < 30; i++) {
                        const r = this.history[this.getTodayKey(-i)];
                        if (r && r.total > 0 && r.taken === r.total) s++;
                        else break;
                    }
                    return s;
                },

                cryptoId() {
                    return Math.random().toString(36).slice(2, 9);
                }
            }
        }
    </script>
</body>

</html>

